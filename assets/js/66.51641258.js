(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{417:function(s,a,e){"use strict";e.r(a);var t=e(26),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"ansible的安装与使用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ansible的安装与使用"}},[s._v("#")]),s._v(" ansible的安装与使用")]),s._v(" "),e("p",[s._v("ansible挺好用的,网上有很丰富的教程.")]),s._v(" "),e("p",[s._v("结合最近的使用情况,我也总结下.")]),s._v(" "),e("p",[s._v("ansible的特点:")]),s._v(" "),e("p",[s._v("1.基于ssh运行")]),s._v(" "),e("p",[s._v("2.无需客户端")]),s._v(" "),e("h2",{attrs:{id:"安装ansible"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装ansible"}},[s._v("#")]),s._v(" 安装ansible")]),s._v(" "),e("p",[s._v("这里提供四种安装方式,根据自己的需要任选一种即可")]),s._v(" "),e("h3",{attrs:{id:"_1-1使用yum安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1使用yum安装"}},[s._v("#")]),s._v(" 1.1使用yum安装")]),s._v(" "),e("p",[s._v("yum install epel-release -y")]),s._v(" "),e("p",[s._v("yum install ansible -y")]),s._v(" "),e("h3",{attrs:{id:"_1-2-使用pip安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-使用pip安装"}},[s._v("#")]),s._v(" 1.2 使用pip安装")]),s._v(" "),e("p",[s._v("pip install ansible")]),s._v(" "),e("p",[s._v("如果没pip,需先安装好pip.方法如下:")]),s._v(" "),e("p",[s._v("yum install python-setuptools")]),s._v(" "),e("p",[s._v("easy_install pip")]),s._v(" "),e("h3",{attrs:{id:"_1-3-源码安装pip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-源码安装pip"}},[s._v("#")]),s._v(" 1.3 源码安装pip")]),s._v(" "),e("p",[s._v("准备工具")]),s._v(" "),e("p",[s._v("yum install git python-setuptools gcc python-devel  -y")]),s._v(" "),e("p",[s._v("获取源码")]),s._v(" "),e("p",[s._v("git clone https://github.com/ansible/ansible")]),s._v(" "),e("p",[s._v("安装ansible")]),s._v(" "),e("p",[s._v("cd ansible")]),s._v(" "),e("p",[s._v("python setup.py install")]),s._v(" "),e("h3",{attrs:{id:"_1-4-brew安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-brew安装"}},[s._v("#")]),s._v(" 1.4 brew安装")]),s._v(" "),e("p",[s._v("在macos下，可使用brew安装")]),s._v(" "),e("p",[s._v("brew install ansible")]),s._v(" "),e("h2",{attrs:{id:"配置服务器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置服务器"}},[s._v("#")]),s._v(" 配置服务器")]),s._v(" "),e("p",[s._v("ansible通过文件来定义你要管理的主机,也就是说把你需要的管理的主机ip写到一个文件中即可。")]),s._v(" "),e("p",[s._v("这个文件一般名为hosts，它可以放在多个路径下，也可以自定义名称和路径。")]),s._v(" "),e("p",[s._v("默认我们用/etc/ansible/hosts这个文件即可")]),s._v(" "),e("p",[s._v("如果是macos 10 以上的系统，默认是没有权限写/etc/的，可以通过自定义配置来添加hosts文件")]),s._v(" "),e("p",[s._v("在~下添加.ansible.cfg文件，指定hosts文件的路径，内容如下")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[defaults]\nhostfile = /usr/local/etc/ansible/hosts\n")])])]),e("p",[s._v("hosts文件的格式为：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[webservers]\n10.2.2.121\n10.2.2.122\n")])])]),e("p",[s._v("这里webservers是主机组的名称，10.2.2.121和10.2.2.122就是具体的服务器ip了")]),s._v(" "),e("p",[s._v("按照这个格式来自定义自己要管理的主机和主机组即可")]),s._v(" "),e("p",[s._v("如我想定义一组名称test的主机，ip分别是10.2.1.201，10.2.1.202")]),s._v(" "),e("p",[s._v("格式如下")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[test]\n10.2.1.201\n10.2.1.202\n")])])]),e("p",[s._v("默认ssh端口是22，如果主机端口号是其他的，在ip后加:端口号即可，如10.2.1.203的端口是2211，属于test组，格式如下：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[test]\n10.2.1.201\n10.2.1.202\n10.2.1.203:2211\n")])])]),e("p",[s._v("如果要定义登录机器的用户名和密码，比如10.2.1.204的用户名是test，密码是admin@test,端口是2244,")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[test]\n10.2.1.201\n10.2.1.202\n10.2.1.203:2211\n10.2.1.204:2244 ansible_ssh_user=test ansible_ssh_pass=admin@test\n")])])]),e("p",[s._v("还可以定义主机的别名，如")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[test]\nweb-01 ansible_host=10.2.1.205 ansible_ssh_user=test ansible_ssh_pass=admin@test ansible_ssh_port=2233\n")])])]),e("p",[s._v("建议使用免密码登录来管理服务器，在ansible的服务器上配置一套ssh的key，通过ssh-copy-id把公钥分发到要管理的服务器上。具体步骤如下：")]),s._v(" "),e("h3",{attrs:{id:"_1-使用ssh-keygen产生ssh密钥"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-使用ssh-keygen产生ssh密钥"}},[s._v("#")]),s._v(" 1.使用ssh-keygen产生ssh密钥")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[root@test-201 ~]# ssh-keygen \nGenerating public/private rsa key pair.\nEnter file in which to save the key (/root/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /root/.ssh/id_rsa.\nYour public key has been saved in /root/.ssh/id_rsa.pub.\nThe key fingerprint is:\ndd:20:23:7c:1a:2e:01:bf:b1:67:7a:08:87:5f:e6:7e root@test-201\nThe key's randomart image is:\n+--[ RSA 2048]----+\n|  .              |\n|   o .           |\n|    + + + .      |\n|   . * = + o     |\n|  o = B S . .    |\n|   + X           |\n|    + o          |\n|     o  E        |\n|      ..         |\n+-----------------+\n")])])]),e("h3",{attrs:{id:"_2-将公钥发送到要管理的服务器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-将公钥发送到要管理的服务器"}},[s._v("#")]),s._v(" 2.将公钥发送到要管理的服务器")]),s._v(" "),e("p",[s._v("使用ssh-copy-id命令")]),s._v(" "),e("p",[s._v("比如要发送到10.2.31.202，使用如下命令：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[root@test-201 ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub 10.2.31.202\nroot@10.2.31.202's password: \nNow try logging into the machine, with \"ssh '10.2.31.202'\", and check in:\n\n  .ssh/authorized_keys\n\nto make sure we haven't added extra keys that you weren't expecting.\n")])])]),e("h2",{attrs:{id:"使用ansible"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用ansible"}},[s._v("#")]),s._v(" 使用ansible")]),s._v(" "),e("p",[s._v("命令格式如下：")]),s._v(" "),e("p",[e("strong",[s._v("ansible + 主机组名称 + -m + 模块名称 + -a  + 参数")])]),s._v(" "),e("p",[s._v("主机组名称，即hosts中定义的主机组名称")]),s._v(" "),e("p",[s._v("-m 指使用模块，后加指定的模块名称")]),s._v(" "),e("p",[s._v("-a  指传给模块的参数")]),s._v(" "),e("p",[s._v("在不指定模块时，默认调用command模块。")]),s._v(" "),e("p",[s._v("如我们想看下test组上的服务器的/tmp下面有哪些文件，可以使用如下命令")]),s._v(" "),e("p",[e("strong",[s._v('ansible test -a "ls /tmp"')])]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('[root@test-201 ~]# ansible test -a "ls /tmp"\n10.2.31.203 | SUCCESS | rc=0 >>\nansible_EMEGZI\ntestabcdefg\n')])])]),e("p",[s._v("我们可以使用copy模块，将本地文件发送到目标服务器上，如：")]),s._v(" "),e("p",[e("strong",[s._v('ansible test -m copy -a "src=/root/install.log dest=/tmp"')])]),s._v(" "),e("p",[s._v("这个命令是将本地的/root/install.log发送到test组的/tmp下，执行的效果如下：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('[root@test-201 ~]# ansible test -m copy -a "src=/root/install.log dest=/tmp"\n10.2.31.203 | SUCCESS => {\n    "changed": true, \n    "checksum": "114ee153946d9cd2e690c405e5796a4fcc400542", \n    "dest": "/tmp/install.log", \n    "gid": 0, \n    "group": "root", \n    "md5sum": "17b18780156a31a65d62a324110d686e", \n    "mode": "0644", \n    "owner": "root", \n    "secontext": "unconfined_u:object_r:admin_home_t:s0", \n    "size": 43688, \n    "src": "/root/.ansible/tmp/ansible-tmp-1466157410.68-191787255687953/source", \n    "state": "file", \n    "uid": 0\n}\n')])])]),e("p",[s._v("你可以使用"),e("strong",[s._v("ansible-doc --list")]),s._v("查看当前的所有模块")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[root@test-201 ~]# ansible-doc  --list                       \n….\n….                                                        \nauthorized_key                     Adds or removes an SSH authorized key                                                                                           \nazure                              create or terminate a virtual machine in azure                                                                                  \nazure_rm_deployment                Create or destroy Azure Resource Manager template deployments                                                                   \nazure_rm_networkinterface          Manage Azure network interfaces.                                                                                                \nazure_rm_networkinterface_facts    Get network interface facts.                                                                                                    \nazure_rm_publicipaddress           Manage Azure Public IP Addresses.                                                                                               \nazure_rm_publicipaddress_facts     Get public IP facts.                                                                                                            \nazure_rm_resourcegroup             Manage Azure resource groups.                                                                                                   \nazure_rm_resourcegroup_facts       Get resource group facts.                                                                                                       \nazure_rm_securitygroup             Manage Azure network security groups.\n….\n…\n")])])]),e("p",[s._v("使用"),e("strong",[s._v("ansible-doc + 模块名")]),s._v("，可以看具体某个模块的使用方法，如查看yum模块的使用方法")]),s._v(" "),e("p",[e("strong",[s._v("ansible-doc  yum")])]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[root@test-201 ~]# ansible-doc  yum\n> YUM\n\n  Installs, upgrade, removes, and lists packages and groups with the `yum' package manager.\n  ......\n  \n")])])]),e("p",[s._v("ansible自带了很多丰富的模块，详细请看：")]),s._v(" "),e("p",[s._v("http://docs.ansible.com/ansible/list_of_all_modules.html")]),s._v(" "),e("h2",{attrs:{id:"playbooks"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#playbooks"}},[s._v("#")]),s._v(" Playbooks")]),s._v(" "),e("p",[s._v("顾名思义，playbooks就像剧本一样，将你要做的事情先定义好，然后通过它来执行。这也是ansible一个强大的地方，可以通过它来做些复杂的应用部署。")]),s._v(" "),e("p",[s._v("举个例子：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[root@test-201 ~]# cat test-playbook\n- hosts: test\n  tasks:\n  - name: 确认apache是否在运行\nservice: name=httpd state=started\n")])])]),e("p",[s._v("这是个很简单的playbooks，首先它指定了要操作的主机组是test，定义了一个名称：确认apache是否在运行，执行pkg=httpd state=latest动作。")]),s._v(" "),e("p",[s._v("执行如下命令")]),s._v(" "),e("h3",{attrs:{id:"ansible-playbook-test-playbook"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ansible-playbook-test-playbook"}},[s._v("#")]),s._v(" ansible-playbook test-playbook")]),s._v(" "),e("p",[s._v("效果如下：")]),s._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("[root@test-201 ~]# ansible-playbook test-playbook \n\nPLAY [test] ********************************************************************\n\nTASK [setup] *******************************************************************\nok: [10.2.31.203]\n\nTASK [确认apache是否在运行] ***********************************************************\nok: [10.2.31.203]\n\nPLAY RECAP *********************************************************************\n10.2.31.203                : ok=2    changed=0    unreachable=0    failed=0\n")])])]),e("p",[s._v("由于playbooks涉及的内容较多,这里就不一一赘述了,更多内容请参考文档： http://ansible-tran.readthedocs.io/en/latest/docs/playbooks.html")]),s._v(" "),e("h2",{attrs:{id:"小技巧"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小技巧"}},[s._v("#")]),s._v(" 小技巧:")]),s._v(" "),e("p",[s._v("有时候如果想直接操作某台服务器,但又没有在hosts里定义这台服务器时,可以使用如下命令:")]),s._v(" "),e("p",[e("strong",[s._v("ansible all -i '服务器ip,'")])]),s._v(" "),e("p",[s._v("注意服务器ip后面要加个,")]),s._v(" "),e("p",[s._v("如")]),s._v(" "),e("p",[s._v("ansible all -i '10.2.31.201,' -u test  -k -a 'uptime'")])])}),[],!1,null,null,null);a.default=n.exports}}]);