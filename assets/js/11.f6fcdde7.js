(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{365:function(t,a,s){"use strict";s.r(a);var n=s(26),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"使用faketime修改docker内的时间-解决cannot-set-date-operation-not-permitted问题"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用faketime修改docker内的时间-解决cannot-set-date-operation-not-permitted问题"}},[t._v("#")]),t._v(" 使用faketime修改docker内的时间,解决cannot set date Operation not permitted问题")]),t._v(" "),s("p",[t._v("docker本质是个进程，有很多资源是使用宿主机的，比如系统时间。正常使用时是会觉得很方便，但涉及到对系统资源的修改时，就比较麻烦了。")]),t._v(" "),s("h3",{attrs:{id:"场景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[t._v("#")]),t._v(" 场景")]),t._v(" "),s("p",[t._v("使用docker部署了一个后端服务，测试需要改系统时间，如果直接改宿主机时间则会影响到其他的docker(不管是在宿主机上改还是通过--cap-add SYS_TIME参数在docker中修改)。有没有什么既能满足测试要求又不影响其他docker的方法呢？答案就是通过faketime来欺骗docker，达到此目的。")]),t._v(" "),s("h3",{attrs:{id:"faketime"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#faketime"}},[t._v("#")]),t._v(" faketime")]),t._v(" "),s("h4",{attrs:{id:"github地址"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#github地址"}},[t._v("#")]),t._v(" github地址")]),t._v(" "),s("p",[t._v("https://github.com/wolfcw/libfaketime")]),t._v(" "),s("h4",{attrs:{id:"安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[t._v("#")]),t._v(" 安装")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("git clone https://github.com/wolfcw/libfaketime\ncd libfaketime\nmake\nmake install\n")])])]),s("p",[t._v("安装完成后，在/usr/local/lib/下有个kaketime的目录")]),t._v(" "),s("h4",{attrs:{id:"使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用"}},[t._v("#")]),t._v(" 使用")]),t._v(" "),s("p",[t._v("比如想修改时间为2019-08-12 10:30:22，执行如下命令")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('export LD_PRELOAD=/usr/local/lib/faketime/libfaketime.so.1 FAKETIME="2019-08-12 10:30:22" \n')])])]),s("h3",{attrs:{id:"docker实践"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker实践"}},[t._v("#")]),t._v(" docker实践")]),t._v(" "),s("h4",{attrs:{id:"dockerfile"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#dockerfile"}},[t._v("#")]),t._v(" dockerfile")]),t._v(" "),s("p",[t._v("先看一个使用Ubuntu基础镜像做的，可用于laravel的dockerfile")]),t._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" ubuntu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("16.04\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 设置时区")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" TZ=Asia/Shanghai\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" ln "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" /etc/timezone\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("7.3.0.tar.bz2 php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("7.3.0.tar.bz2\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 更新源，安装nginx")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" sed "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("i "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/archive.ubuntu.com/mirrors.aliyun.com/g'")]),t._v(" /etc/apt/sources.list \\\n    && sed "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("i "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/security.ubuntu.com/mirrors.aliyun.com/g'")]),t._v(" /etc/apt/sources.list \\\n    && apt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("get clean \\\n    && rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fR /var/lib/apt/lists/* \\\n    && mkdir /var/lib/apt/lists/partial \\\n    && apt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("get update  \\\n    && apt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("get upgrade "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("y \\\n    && apt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("get install "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("y wget autoconf make gcc nginx procps libfreetype6"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libpng"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libzip"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libcurl3"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("openssl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libbz2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libjpeg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libxpm"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libfreetype6"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libmcrypt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libmysql++"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libxslt1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev  pkg"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config libssl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev libsslcommon2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("dev zip unzip \\\n    && tar xvf php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("7.3.0.tar.bz2 \\\n    && cd php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("7.3.0/ \\\n    && ./configure  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("prefix=/usr/local/php "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("enable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fpm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("enable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sockets "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("enable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("mbstring=all  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("enable"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("mysqlnd  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("file"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("path=/usr/local/php/etc "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("mysqli=mysqlnd "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("pdo"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("mysql=mysqlnd "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("curl "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("gd  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("openssl \\\n    && make \\\n    && make install \\\n    && cd ext/zip \\\n    && /usr/local/php/bin/phpize \\\n    && ./configure "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config=/usr/local/php/bin/php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config \\\n    && make ; make install \\\n    && cd ../../ext/bcmath \\\n    && /usr/local/php/bin/phpize \\\n    && ./configure "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("with"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config=/usr/local/php/bin/php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config \\\n    && make ; make install \\\n    && cd ../../.. ; rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fr php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("7.3.0 ; rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fr php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("7.3.0.tar.bz2 \n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 安装 Composer")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" COMPOSER_HOME /root/composer\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" composer /usr/bin/composer\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" composer /usr/local/bin/composer\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" cp /usr/local/php/bin/php /usr/bin && composer config "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("g repo.packagist composer https"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//mirrors.aliyun.com/composer/\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 复制文件和代码")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /data\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" app/ /data/\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" php.ini /usr/local/etc/php/php.ini\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" libfaketime/ /data/\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" echo "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'extension=zip.so'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" /usr/local/php/etc/php.ini \\\n    && echo "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'extension=bcmath.so'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" /usr/local/php/etc/php.ini \\\n    && cd /data/libfaketime && make ; make install \\\n    && rm "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fr /data/libfaketime\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fpm.conf /usr/local/php/etc/php"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("fpm.conf\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" nginx.conf /etc/nginx/nginx.conf\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" env"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("example /data/.env\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Write Permission")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" chmod "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("R 777 /data && usermod "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("u 1000 www"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("data\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"nginx"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-g"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"daemon off;"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("h4",{attrs:{id:"说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#说明"}},[t._v("#")]),t._v(" 说明")]),t._v(" "),s("ol",[s("li",[t._v("dockerfile的大概过程是：安装基本工具和依赖；编译安装php；复制composer，faketime到docker，编译安装faktime；复制项目代码，nginx配置，php配置到docker；使用nginx做前台进程启动docker。")]),t._v(" "),s("li",[t._v("用Ubuntu而不用PHP做docker基础镜像的原因是: 测试修改时间时要重启php-fpm，如果直接使用PHP的docker则重启php-fpm后docker会重启，faketime修改无效。")]),t._v(" "),s("li",[t._v("在docker里面下载php-7.3.0.tar.bz2，composer和faketime，如果网络不好则时间会比较长，这改成先下载好，然后拷贝到docker里打包，节省点时间。nginx，php-fpm的配置也要事先准备好。")]),t._v(" "),s("li",[t._v("由于是编译安装php，时间会长一点")])]),t._v(" "),s("h4",{attrs:{id:"使用-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用-2"}},[t._v("#")]),t._v(" 使用")]),t._v(" "),s("p",[t._v("先使用该dockerfile打个包")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker build -t laravel:v1 .\n")])])]),s("p",[t._v("打完之后运行起来")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('docker run -itd  -p 9091:80 laravel:v1\n\ndocker ps\nCONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES\nd5fcc8f42bd4        laravel:v1          "nginx -g \'daemon of…"   37 seconds ago      Up 35 seconds       0.0.0.0:9091->80/tcp   trusting_darwin\n')])])]),s("p",[t._v("进入docker")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("docker exec -it d5fcc8f42bd4 /bin/bash\nroot@d5fcc8f42bd4:/data# \n")])])]),s("p",[t._v("修改时间下时间")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('root@d5fcc8f42bd4:/data# date\nSun Aug 25 15:24:40 Asia 2019\nroot@d5fcc8f42bd4:/data# \nroot@d5fcc8f42bd4:/data# export LD_PRELOAD=/usr/local/lib/faketime/libfaketime.so.1 FAKETIME="2019-08-12 10:30:22" \nroot@d5fcc8f42bd4:/data# date\nMon Aug 12 10:30:22 Asia 2019\n')])])]),s("p",[t._v("可以看到当前终端的时间已经改了。\n看看当前终端下php的时间是不是也改了：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("root@d5fcc8f42bd4:/data# echo \"<?php echo date('Y-m-d H:i:s'); \" > time.php\nroot@d5fcc8f42bd4:/data# echo 'echo \"\\n\";' >> time.php\nroot@d5fcc8f42bd4:/data# date\nMon Aug 12 10:30:22 Asia 2019\nroot@d5fcc8f42bd4:/data# php time.php \n2019-08-12 10:30:22\n")])])]),s("p",[t._v("可以看到也修改了。\n再来改下php-fpm的时间")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("pkill php-fpm ; /usr/local/php/sbin/php-fpm \n")])])]),s("p",[t._v("访问http://127.0.0.1:9091/time.php ，可以看到当前的运行时间也改了。")]),t._v(" "),s("p",[s("s",[t._v("不过目前测试php-fpm的生效时间比较短，只有10秒左右，之后会还原，后续在找下原因完善下。")])]),t._v(" "),s("p",[t._v("------------- 关于php-fpm时间还原问题的更新")]),t._v(" "),s("p",[t._v("对于php-fpm模式，可以在配置文件中加一个参数clear_env = no，启动php-fpm时则不会清空环境变量，修改的时间就能一直生效了。")]),t._v(" "),s("p",[t._v("对于CLI或swoole模式则没有这个问题，修改时间后重启即可。")])])}),[],!1,null,null,null);a.default=e.exports}}]);