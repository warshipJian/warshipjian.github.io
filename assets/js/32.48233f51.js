(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{383:function(e,n,a){"use strict";a.r(n);var s=a(26),t=Object(s.a)({},(function(){var e=this,n=e.$createElement,a=e._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"在线修改表结构ddl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在线修改表结构ddl"}},[e._v("#")]),e._v(" 在线修改表结构DDL")]),e._v(" "),a("p",[e._v("表的数据比较大时，如果直接修改会阻塞表，影响业务数据。有两个工具可以实现：")]),e._v(" "),a("p",[a("strong",[e._v("pt-online-schema-change")]),e._v(" 和 "),a("strong",[e._v("gh-ost")])]),e._v(" "),a("p",[e._v("这次使用pt-online-schema-change")]),e._v(" "),a("p",[a("strong",[e._v("参考：https://segmentfault.com/a/1190000014924677")])]),e._v(" "),a("h3",{attrs:{id:"一-安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一-安装"}},[e._v("#")]),e._v(" 一.安装")]),e._v(" "),a("p",[e._v("进入官网选择好对应的版本，下载到服务器")]),e._v(" "),a("p",[e._v("https://www.percona.com/downloads/percona-toolkit/LATEST/")]),e._v(" "),a("p",[e._v("本次是Ubuntu 16.04")]),e._v(" "),a("p",[e._v("下载完成后安装下")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("dpkg -i percona-toolkit_3.1.0-2.xenial_amd64.deb \napt-get install percona-toolkit\napt-get -f install\n")])])]),a("h3",{attrs:{id:"二-使用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#二-使用"}},[e._v("#")]),e._v(" 二.使用")]),e._v(" "),a("p",[e._v("参考选项")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("--user=        连接mysql的用户名\n--password=    连接mysql的密码\n--host=        连接mysql的地址\nP=3306         连接mysql的端口号\nD=             连接mysql的库名\nt=             连接mysql的表名\n--alter        修改表结构的语句\n--execute      执行修改表结构\n--charset=utf8 使用utf8编码，避免中文乱码\n--no-version-check  不检查版本，在阿里云服务器中一般加入此参数，否则会报错\n")])])]),a("p",[e._v("写成一个sh脚本，便于使用")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("#!/bin/bash\ntable=$1\nalter_conment=$2\n\ncnn_host='127.0.0.1'\ncnn_user='user'\ncnn_pwd='password'\ncnn_db='database_name'\n\necho \"$table\"\necho \"$alter_conment\"\n/root/percona-toolkit-2.2.19/bin/pt-online-schema-change --charset=utf8 --no-version-check --user=${cnn_user} --password=${cnn_pwd} --host=${cnn_host}  P=3306,D=${cnn_db},t=$table --alter \n\"${alter_conment}\" --execute\n")])])]),a("p",[e._v("本次是增加一个索引，表有2千万行，执行了大概20分钟，由于不影响在线业务，完全可以接受。\n执行如下命令")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("sh pt-online.sh custom_game_score 'ADD INDEX IDX_S_USER_ID(user_id)'\n")])])]),a("p",[e._v("结果")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("custom_game_score\nADD INDEX IDX_S_USER_ID(user_id)\nCannot connect to A=utf8mb4,P=3017,h=,p=...,u=yewu_custom\nNo slaves found.  See --recursion-method if host h=abc.mysql.rds.aliyuncs.com,P=3306 has slaves.\nNot checking slave lag because no slaves were found and --check-slave-lag was not specified.\nOperation, tries, wait:\n  analyze_table, 10, 1\n  copy_rows, 10, 0.25\n  create_triggers, 10, 1\n  drop_triggers, 10, 1\n  swap_tables, 10, 1\n  update_foreign_keys, 10, 1\nAltering `yewu`.`custom_game_score`...\nCreating new table...\nCreated new table yewu._custom_game_score_new OK.\nAltering new table...\nAltered `yewu`.`_custom_game_score_new` OK.\n2019-10-29T19:50:33 Creating triggers...\n2019-10-29T19:50:33 Created triggers OK.\n2019-10-29T19:50:33 Copying approximately 27589521 rows...\nCopying `yewu`.`custom_game_score`:   3% 14:17 remain\nCopying `yewu`.`custom_game_score`:   6% 13:36 remain\nCopying `yewu`.`custom_game_score`:   9% 13:42 remain\nCopying `yewu`.`custom_game_score`:  12% 13:34 remain\nCopying `yewu`.`custom_game_score`:  15% 13:11 remain\nCopying `yewu`.`custom_game_score`:  18% 12:50 remain\nCopying `yewu`.`custom_game_score`:  21% 12:31 remain\nCopying `yewu`.`custom_game_score`:  24% 12:19 remain\nCopying `yewu`.`custom_game_score`:  27% 12:07 remain\nCopying `yewu`.`custom_game_score`:  29% 11:42 remain\nCopying `yewu`.`custom_game_score`:  32% 11:20 remain\nCopying `yewu`.`custom_game_score`:  35% 10:59 remain\nCopying `yewu`.`custom_game_score`:  37% 10:37 remain\nCopying `yewu`.`custom_game_score`:  40% 10:11 remain\nCopying `yewu`.`custom_game_score`:  43% 09:41 remain\nCopying `yewu`.`custom_game_score`:  46% 09:16 remain\nCopying `yewu`.`custom_game_score`:  49% 08:46 remain\nCopying `yewu`.`custom_game_score`:  52% 08:10 remain\nCopying `yewu`.`custom_game_score`:  55% 07:41 remain\nCopying `yewu`.`custom_game_score`:  58% 07:12 remain\nCopying `yewu`.`custom_game_score`:  60% 06:42 remain\nCopying `yewu`.`custom_game_score`:  63% 06:15 remain\nCopying `yewu`.`custom_game_score`:  66% 05:49 remain\nCopying `yewu`.`custom_game_score`:  69% 05:19 remain\nCopying `yewu`.`custom_game_score`:  72% 04:48 remain\nCopying `yewu`.`custom_game_score`:  75% 04:18 remain\nCopying `yewu`.`custom_game_score`:  77% 03:51 remain\nCopying `yewu`.`custom_game_score`:  80% 03:22 remain\nCopying `yewu`.`custom_game_score`:  83% 02:55 remain\nCopying `yewu`.`custom_game_score`:  85% 02:27 remain\nCopying `yewu`.`custom_game_score`:  88% 01:56 remain\nCopying `yewu`.`custom_game_score`:  91% 01:27 remain\nCopying `yewu`.`custom_game_score`:  94% 00:58 remain\nCopying `yewu`.`custom_game_score`:  97% 00:31 remain\nCopying `yewu`.`custom_game_score`:  99% 00:03 remain\n2019-10-29T20:08:46 Copied rows OK.\n2019-10-29T20:08:46 Analyzing new table...\n2019-10-29T20:08:46 Swapping tables...\n2019-10-29T20:08:46 Swapped original and new tables OK.\n2019-10-29T20:08:46 Dropping old table...\n2019-10-29T20:08:47 Dropped old table `yewu`.`_custom_game_score_old` OK.\n2019-10-29T20:08:47 Dropping triggers...\n2019-10-29T20:08:47 Dropped triggers OK.\nSuccessfully altered `yewu`.`custom_game_score`.\n")])])]),a("h3",{attrs:{id:"三-triggers触发器问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#三-triggers触发器问题"}},[e._v("#")]),e._v(" 三.triggers触发器问题")]),e._v(" "),a("p",[e._v("由于pt-online-schema-change需要一个自己的触发器，如果表中有触发器了，则不能使用pt-online-schema-change。")]),e._v(" "),a("p",[e._v("处理方法有两个：")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("1.删除触发器\n2.使用其他工具，比如gh-ost\n")])])]),a("p",[e._v("查看一下这个表的触发器")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("mysql> show triggers like '%custom_game_score%';\n+-----------------+--------+-------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------+---------+----------+------------+----------------------+----------------------+--------------------+\n| Trigger         | Event  | Table             | Statement                                                                                                                                                                                                                                | Timing | Created | sql_mode | Definer    | character_set_client | collation_connection | Database Collation |\n+-----------------+--------+-------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------+---------+----------+------------+----------------------+----------------------+--------------------+\n| GAME_SCORE_BACK | DELETE | custom_game_score | insert into yewu_bak.custom_game_score (id, user_id, game_id, last_score, score, times, device_type, create_time)\nvalues (old.id, old.user_id, old.game_id, old.last_score, old.score, old.times, old.device_type, old.create_time) | AFTER  | NULL    |          | yewu@% | utf8                 | utf8_general_ci      | utf8mb4_general_ci |\n+-----------------+--------+-------------------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------+---------+----------+------------+----------------------+----------------------+--------------------+\n1 row in set (0.00 sec)\n")])])]),a("p",[e._v("发现是备份数据到另一个库，其实完全不用，故删除之")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("mysql> DROP TRIGGER GAME_SCORE_BACK;\nQuery OK, 0 rows affected (0.00 sec)\n")])])])])}),[],!1,null,null,null);n.default=t.exports}}]);