<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用openvpn连通多个机房内网 | 小小郭的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="小小郭">
    <link rel="preload" href="/assets/css/0.styles.f333096b.css" as="style"><link rel="preload" href="/assets/js/app.158714e6.js" as="script"><link rel="preload" href="/assets/js/2.a806d99a.js" as="script"><link rel="preload" href="/assets/js/35.53e76add.js" as="script"><link rel="prefetch" href="/assets/js/10.ceb6da30.js"><link rel="prefetch" href="/assets/js/11.f6fcdde7.js"><link rel="prefetch" href="/assets/js/12.c1ccc7c5.js"><link rel="prefetch" href="/assets/js/13.2e80b5f4.js"><link rel="prefetch" href="/assets/js/14.86580eea.js"><link rel="prefetch" href="/assets/js/15.ec8bc9ac.js"><link rel="prefetch" href="/assets/js/16.ffe6c259.js"><link rel="prefetch" href="/assets/js/17.f11cefb5.js"><link rel="prefetch" href="/assets/js/18.ba7fa50a.js"><link rel="prefetch" href="/assets/js/19.d98194cd.js"><link rel="prefetch" href="/assets/js/20.b3e3e3ba.js"><link rel="prefetch" href="/assets/js/21.0560925d.js"><link rel="prefetch" href="/assets/js/22.151f504b.js"><link rel="prefetch" href="/assets/js/23.c0dd585a.js"><link rel="prefetch" href="/assets/js/24.5ac8c4b5.js"><link rel="prefetch" href="/assets/js/25.57989e7c.js"><link rel="prefetch" href="/assets/js/26.19ae4c70.js"><link rel="prefetch" href="/assets/js/27.7b7a4013.js"><link rel="prefetch" href="/assets/js/28.c02de8fb.js"><link rel="prefetch" href="/assets/js/29.be98b5ac.js"><link rel="prefetch" href="/assets/js/3.f9a5341d.js"><link rel="prefetch" href="/assets/js/30.151ce4ad.js"><link rel="prefetch" href="/assets/js/31.e3b05220.js"><link rel="prefetch" href="/assets/js/32.48233f51.js"><link rel="prefetch" href="/assets/js/33.cdf1ba85.js"><link rel="prefetch" href="/assets/js/34.8e175bdf.js"><link rel="prefetch" href="/assets/js/36.2588db5d.js"><link rel="prefetch" href="/assets/js/37.904d3476.js"><link rel="prefetch" href="/assets/js/38.1424f189.js"><link rel="prefetch" href="/assets/js/39.0e05003b.js"><link rel="prefetch" href="/assets/js/4.84d9a9b8.js"><link rel="prefetch" href="/assets/js/40.e4b36098.js"><link rel="prefetch" href="/assets/js/41.13258ed7.js"><link rel="prefetch" href="/assets/js/42.6f5a7cbb.js"><link rel="prefetch" href="/assets/js/43.7898149d.js"><link rel="prefetch" href="/assets/js/44.37b08732.js"><link rel="prefetch" href="/assets/js/45.17998593.js"><link rel="prefetch" href="/assets/js/46.055bc79a.js"><link rel="prefetch" href="/assets/js/47.6df10fa7.js"><link rel="prefetch" href="/assets/js/48.2660180a.js"><link rel="prefetch" href="/assets/js/49.4625a12a.js"><link rel="prefetch" href="/assets/js/5.501f4465.js"><link rel="prefetch" href="/assets/js/50.b3b348da.js"><link rel="prefetch" href="/assets/js/51.dcb3be6c.js"><link rel="prefetch" href="/assets/js/52.7dd04b5b.js"><link rel="prefetch" href="/assets/js/53.20259b4b.js"><link rel="prefetch" href="/assets/js/54.c876d67f.js"><link rel="prefetch" href="/assets/js/55.52c8359c.js"><link rel="prefetch" href="/assets/js/56.ab71b89a.js"><link rel="prefetch" href="/assets/js/57.30af5fe9.js"><link rel="prefetch" href="/assets/js/58.d1f3acb8.js"><link rel="prefetch" href="/assets/js/59.0c65a864.js"><link rel="prefetch" href="/assets/js/6.56baaf4e.js"><link rel="prefetch" href="/assets/js/60.cc2dc3eb.js"><link rel="prefetch" href="/assets/js/61.bc3d577e.js"><link rel="prefetch" href="/assets/js/62.88dedbc6.js"><link rel="prefetch" href="/assets/js/63.5403d296.js"><link rel="prefetch" href="/assets/js/64.cdcabf93.js"><link rel="prefetch" href="/assets/js/65.7fba108e.js"><link rel="prefetch" href="/assets/js/66.51641258.js"><link rel="prefetch" href="/assets/js/67.f408a0b2.js"><link rel="prefetch" href="/assets/js/68.326016eb.js"><link rel="prefetch" href="/assets/js/69.9dde49ee.js"><link rel="prefetch" href="/assets/js/7.86ee5bb7.js"><link rel="prefetch" href="/assets/js/70.76be6feb.js"><link rel="prefetch" href="/assets/js/71.8bb3d5a3.js"><link rel="prefetch" href="/assets/js/72.3d340b56.js"><link rel="prefetch" href="/assets/js/73.94ae8b58.js"><link rel="prefetch" href="/assets/js/74.c38b2bf5.js"><link rel="prefetch" href="/assets/js/75.ab88131c.js"><link rel="prefetch" href="/assets/js/76.b15fc67e.js"><link rel="prefetch" href="/assets/js/8.77896323.js"><link rel="prefetch" href="/assets/js/9.1bb7c316.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f333096b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小小郭的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">
  关于我
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用openvpn连通多个机房内网"><a href="#使用openvpn连通多个机房内网" class="header-anchor">#</a> 使用openvpn连通多个机房内网</h1> <h2 id="一-环境简述"><a href="#一-环境简述" class="header-anchor">#</a> 一.环境简述</h2> <p>之前一直使用公网ip来连接各个机房的服务器,现在ip不太够用了,而且有些机器也不需要用到公网ip.通过openvpn将多个机房连接起来,组成一个局域网,机器ip可以做到唯一性,便于标识.既节省了ip.又方便管理.</p> <p>本例环境如下,服务器使用的系统为centos 7.1</p> <p><img src="https://img.xiaoxiaoguo.cn/usr/uploads/2017/07/738096363.jpg" alt="openvpn.jpg"></p> <p>北京机房内网网段 172.16.2.0/24,服务器公网ip 20.20.20.20,内网网关172.16.2.1</p> <p>广州机房内网网段 172.16.1.0/24,服务器公网ip 10.10.10.10,内网网关172.16.1.1</p> <p>公司内网网段 172.16.3.0/24,防火墙公网ip 30.30.30.30,内网网关172.16.3.1,内网服务器ip 172.16.3.88</p> <p>实现思路:</p> <p>1.在广州机房搭建一个openvpn服务端,北京和公司内网各选一台服务器做openvpn的客户端连接广州.</p> <p>2.openvpn使用桥接模式,开启client-to-client.北京和公司都连上后,这3台机器默认就能互访.</p> <p>3.各内网网段的互通使用静态路由.</p> <h2 id="二-广州安装openvpn服务端"><a href="#二-广州安装openvpn服务端" class="header-anchor">#</a> 二.广州安装openvpn服务端</h2> <p>安装前需注意服务器的系统时间要一致,可按如下方法同步:</p> <div class="language- extra-class"><pre class="language-text"><code>/usr/sbin/ntpdate cn.pool.ntp.org
</code></pre></div><h3 id="_1-安装openvpn"><a href="#_1-安装openvpn" class="header-anchor">#</a> 1.安装openvpn</h3> <p>如果没epel源,先添加下</p> <div class="language- extra-class"><pre class="language-text"><code>wget  http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-5.noarch.rpm
rpm -Uvh epel-release-7-5.noarch.rpm
yum -y install openvpn easy-rsa 
</code></pre></div><h3 id="_2-创建证书"><a href="#_2-创建证书" class="header-anchor">#</a> 2.创建证书</h3> <div class="language- extra-class"><pre class="language-text"><code>cp -r /usr/share/easy-rsa/ /etc/openvpn/
cd /etc/openvpn/easy-rsa/2.*/
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>vim vars
</code></pre></div><p>设置如下内容</p> <div class="language- extra-class"><pre class="language-text"><code>export KEY_COUNTRY=&quot;CN&quot;
export KEY_PROVINCE=&quot;GD&quot;
export KEY_CITY=&quot;guangzhou&quot;
export KEY_ORG=&quot;test&quot;
export KEY_EMAIL=&quot;me@myhost.mydomain&quot;
export KEY_OU=&quot;MyOrganizationalUnit&quot;
# X509 Subject Field
export KEY_NAME=&quot;EasyRSA&quot;
</code></pre></div><p>产生证书</p> <div class="language- extra-class"><pre class="language-text"><code>source ./vars
./clean-all
./build-ca

./build-key-server server
./build-dh
./build-key client

cd /etc/openvpn/easy-rsa/2.0/
cp -r keys/ /etc/openvpn/
</code></pre></div><h3 id="_3-配置openvpn"><a href="#_3-配置openvpn" class="header-anchor">#</a> 3.配置openvpn</h3> <div class="language- extra-class"><pre class="language-text"><code>vim /etc/openvpn/server.conf
</code></pre></div><p>关键配置如下:</p> <div class="language- extra-class"><pre class="language-text"><code>port 1194
proto udp
dev tap0
ca /etc/openvpn/keys/ca.crt
cert /etc/openvpn/keys/server.crt
key /etc/openvpn/keys/server.key
dh /etc/openvpn/keys/dh2048.pem
ifconfig-pool-persist ipp.txt
server-bridge 172.16.1.1 255.255.255.0 172.16.1.2 172.16.1.10
client-config-dir ccd
client-to-client
duplicate-cn
keepalive 10 120
comp-lzo
user nobody
group nobody
persist-key
persist-tun
status openvpn-status.log
verb 4
mute 20
script-security 3 
#验证用户名密码脚本
auth-user-pass-verify /etc/openvpn/checkpsw.sh via-env 
#开启用户名和密码验证,用于服务端分配固定ip
username-as-common-name
client-config-dir /etc/openvpn/ccd #用于服务端分配固定ip
</code></pre></div><p>设置用户名和密码，并设置固定分配ip</p> <div class="language- extra-class"><pre class="language-text"><code>cd /etc/openvpn
vim psw-file
#这里设置用于连接openvpn的用户名和密码,格式为用户名 + 空格 +密码，例如
bj test123456
com test123456

#在该目录下再新建一个ccd文件夹
mkdir ccd
cd ccd

#在该目录下新建两个文件，把用户名作为文件名的命名

vi bj
#添加如下内容
ifconfig-push 172.16.1.2 255.255.255.0

vi com
#添加如下内容
ifconfig-push 172.16.1.3 255.255.255.0
</code></pre></div><h3 id="４-添加密码验证脚本"><a href="#４-添加密码验证脚本" class="header-anchor">#</a> ４.添加密码验证脚本</h3> <div class="language- extra-class"><pre class="language-text"><code>vi /etc/openvpn/checkpsw.sh
</code></pre></div><p>内容如下</p> <div class="language- extra-class"><pre class="language-text"><code>#!/bin/sh
###########################################################
# checkpsw.sh (C) 2004 Mathias Sundman &lt;mathias@openvpn.se&gt;
#
# This script will authenticate OpenVPN users against
# a plain text file. The passfile should simply contain
# one row per user with the username first followed by
# one or more space(s) or tab(s) and then the password.

PASSFILE=&quot;/etc/openvpn/psw-file&quot;
LOG_FILE=&quot;/var/log/openvpn-password.log&quot;
TIME_STAMP=`date &quot;+%Y-%m-%d %T&quot;`

###########################################################

if [ ! -r &quot;${PASSFILE}&quot; ]; then
  echo &quot;${TIME_STAMP}: Could not open password file \&quot;${PASSFILE}\&quot; for reading.&quot; &gt;&gt; ${LOG_FILE}
  exit 1
fi

CORRECT_PASSWORD=`awk '!/^;/&amp;&amp;!/^#/&amp;&amp;$1==&quot;'${username}'&quot;{print $2;exit}' ${PASSFILE}`

if [ &quot;${CORRECT_PASSWORD}&quot; = &quot;&quot; ]; then 
  echo &quot;${TIME_STAMP}: User does not exist: username=\&quot;${username}\&quot;, password=\&quot;${password}\&quot;.&quot; &gt;&gt; ${LOG_FILE}
  exit 1
fi

if [ &quot;${password}&quot; = &quot;${CORRECT_PASSWORD}&quot; ]; then 
  echo &quot;${TIME_STAMP}: Successful authentication: username=\&quot;${username}\&quot;.&quot; &gt;&gt; ${LOG_FILE}
  exit 0
fi

echo &quot;${TIME_STAMP}: Incorrect password: username=\&quot;${username}\&quot;, password=\&quot;${password}\&quot;.&quot; &gt;&gt; ${LOG_FILE}
exit 1
</code></pre></div><h3 id="_5-ip配置"><a href="#_5-ip配置" class="header-anchor">#</a> 5.IP配置</h3> <p>给openVPN服务端的网卡配置ip时，有两种方式选择：桥接或者在配置文件中设置，这里两种都示例下，选择任意一个即可，推荐用配置文件分配(简单些~)。</p> <h4 id="_5-1-在配置文件中指定"><a href="#_5-1-在配置文件中指定" class="header-anchor">#</a> 5.1 在配置文件中指定</h4> <div class="language- extra-class"><pre class="language-text"><code>vim /etc/openvpn/server.conf
</code></pre></div><p>在ifconfig-pool-persist ipp.txt下添加一行</p> <div class="language- extra-class"><pre class="language-text"><code>ifconfig 172.16.1.1 255.255.255.0
</code></pre></div><h4 id="_5-2-通过桥接分配"><a href="#_5-2-通过桥接分配" class="header-anchor">#</a> 5.2 通过桥接分配</h4> <h5 id="_5-2-1-启动桥接脚本"><a href="#_5-2-1-启动桥接脚本" class="header-anchor">#</a> 5.2.1 启动桥接脚本</h5> <div class="language- extra-class"><pre class="language-text"><code>#!/bin/bash
#################################
# Set up Ethernet bridge on Linux
# Requires: bridge-utils
#################################
# Define Bridge Interface
br=&quot;br0&quot;
# Define list of TAP interfaces to be bridged,
# for example tap=&quot;tap0 tap1 tap2&quot;.
tap=&quot;tap0&quot;
# Define physical ethernet interface to be bridged
# with TAP interface(s) above.
eth=&quot;ens9&quot; #这里注意下网卡名
eth_ip=&quot;172.16.1.1&quot;
eth_netmask=&quot;255.255.255.0&quot;
eth_broadcast=&quot;172.16.1.255&quot;
for t in $tap; do
   /usr/sbin/openvpn --mktun --dev $t
done
brctl addbr $br
brctl addif $br $eth
for t in $tap; do
    brctl addif $br $t
done
for t in $tap; do
    ifconfig $t 0.0.0.0 promisc up
done
ifconfig $eth 0.0.0.0 promisc up
ifconfig $br $eth_ip netmask $eth_netmask broadcast $eth_broadcast
route add -net 172.16.2.0/24 gw 172.16.1.2
route add -net 172.16.3.0/24 gw 172.16.1.3
</code></pre></div><h4 id="_5-2-2-停止桥接脚本"><a href="#_5-2-2-停止桥接脚本" class="header-anchor">#</a> 5.2.2 停止桥接脚本</h4> <div class="language- extra-class"><pre class="language-text"><code>#!/bin/bash
####################################
# Tear Down Ethernet bridge on Linux
####################################
# Define Bridge Interface
br=&quot;br0&quot;
# Define list of TAP interfaces to be bridged together
tap=&quot;tap0&quot;
ifconfig $br down
brctl delbr $br
for t in $tap; do
    /usr/sbin/openvpn --rmtun --dev $t
done
</code></pre></div><h3 id="_6-设置iptables"><a href="#_6-设置iptables" class="header-anchor">#</a> 6.设置iptables</h3> <div class="language- extra-class"><pre class="language-text"><code>nat链添加如下规则
-A POSTROUTING -s 10.8.0.0/24 -o eth1 -j MASQUERADE
-A POSTROUTING -s 172.16.0.0/16 -j MASQUERADE

filter链添加如下规则
-A INPUT -s 20.20.20.0/24  -j ACCEPT
-A INPUT -s ３0.３0.３0.0/24  -j ACCEPT
-A INPUT -s 172.16.0.0/16 -j ACCEPT
-A FORWARD -j ACCEPT
</code></pre></div><h3 id="_7-启动openvpn"><a href="#_7-启动openvpn" class="header-anchor">#</a> 7.启动openvpn</h3> <div class="language- extra-class"><pre class="language-text"><code>echo 'net.ipv4.ip_forward = 1' &gt;&gt; /etc/sysctl.conf
sysctl -p
systemctl -f enable openvpn@server.service
systemctl start openvpn@server
</code></pre></div><h2 id="三．北京-公司内网连接广州openvpn，打通内网"><a href="#三．北京-公司内网连接广州openvpn，打通内网" class="header-anchor">#</a> 三．北京,公司内网连接广州openvpn，打通内网</h2> <p>以北京20.20.20.20服务器为例</p> <p>１.安装openvpn,步骤同上</p> <p>２.将openvpn服务端(10.10.10.10)的三个证书文件ca.crt  client.crt  client.key（路径/etc/openvpn/keys）拷贝到/etc/openvpn/下</p> <p>３.添加openvpn启动脚本</p> <div class="language- extra-class"><pre class="language-text"><code>cd /etc/openvpn

vi client.sh
＃添加如下内容
#!/bin/sh
case &quot;$1&quot; in
start)
    /usr/sbin/openvpn /etc/openvpn/client.ovpn &gt; /dev/null &amp;
    sleep 5
    route add -net 172.16.3.0/24 gw 172.16.1.3
;;
stop)
    pkill openvpn
;;
restart)
    pkill openvpn
    sleep 2
    /usr/sbin/openvpn /etc/openvpn/client.ovpn &gt; /dev/null &amp;
;;
esac

vi psw.conf
＃添加如下内容
bj
test123456

vi client.ovpn
#添加如下内容
client
dev tap
proto udp
remote 10.10.10.10 1194
resolv-retry infinite
nobind
persist-key
persist-tun
mute-replay-warnings
ca ca.crt
cert client.crt
key client.key
ns-cert-type server
comp-lzo
auth-user-pass psw.conf

添加执行权限
chmod +x client.sh

＃加入系统启动项
echo '(cd /etc/openvpn; ./client.sh start)' &gt;&gt; /etc/rc.local
</code></pre></div><p>4.设置iptables</p> <div class="language- extra-class"><pre class="language-text"><code>nat链添加如下规则
-A POSTROUTING -d 172.16.0.0/16 -o tap0 -j MASQUERADE

filter链添加如下规则
-A FORWARD -i eth0 -o tap0 -j ACCEPT
-A FORWARD -i tap0 -o eth0 -j ACCEPT
</code></pre></div><p>５.设置完成后，重启下防火墙，启动openvpn</p> <div class="language- extra-class"><pre class="language-text"><code>systemctl restart iptables
(cd /etc/openvpn; ./client.sh start)

ping下广州内网网关172.16.1.1,如果ping通说明北京与广州可以互通了．
＃ping 172.16.1.1 -c 4
PING 172.16.1.1 (172.16.1.1) 56(84) bytes of data.
64 bytes from 172.16.1.1: icmp_seq=1 ttl=64 time=37.1 ms
64 bytes from 172.16.1.1: icmp_seq=2 ttl=64 time=37.0 ms
64 bytes from 172.16.1.1: icmp_seq=3 ttl=64 time=37.2 ms
64 bytes from 172.16.1.1: icmp_seq=4 ttl=64 time=37.0 ms

--- 172.16.1.1 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3040ms
rtt min/avg/max/mdev = 37.053/37.133/37.268/0.083 ms
</code></pre></div><p>６.公司内网openvpn连接设置与北京一样，注意用户名密码及路由的不同：</p> <div class="language- extra-class"><pre class="language-text"><code>公司内网的openvpn的启动脚本如下：
vi client.sh
＃添加如下内容
#!/bin/sh
case &quot;$1&quot; in
start)
    /usr/sbin/openvpn /etc/openvpn/client.ovpn &gt; /dev/null &amp;
    sleep 5
    route add -net 172.16.２.0/24 gw 172.16.１.２
;;
stop)
    pkill openvpn
;;
restart)
    pkill openvpn
    sleep 2
    /usr/sbin/openvpn /etc/openvpn/client.ovpn &gt; /dev/null &amp;
;;
esac
</code></pre></div><p>7.北京，公司内网的openvpn都连接上后，在广州openvpn的服务器上添加如下路由</p> <div class="language- extra-class"><pre class="language-text"><code>route add -net 172.16.2.0/24 gw 172.16.1.2
route add -net 172.16.3.0/24 gw 172.16.1.3
</code></pre></div><p>８.以上步骤成功完成后，北京内网，广州内网，公司内网即可互相访问．在任意的一台服务器上都可以访问其他节点的服务器，实现了内网互通的需求．</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div> <footer><div style="text-align: center;">
            © 2020 小小郭的博客
            <a href="http://www.beian.miit.gov.cn/">粤ICP备16016910号</a> <br><br></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.158714e6.js" defer></script><script src="/assets/js/2.a806d99a.js" defer></script><script src="/assets/js/35.53e76add.js" defer></script>
  </body>
</html>
