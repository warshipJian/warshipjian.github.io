(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{422:function(t,s,a){"use strict";a.r(s);var n=a(26),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"gitlab的runner实践"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab的runner实践"}},[t._v("#")]),t._v(" gitlab的runner实践")]),t._v(" "),a("p",[t._v("公司的项目有个特点：项目多。")]),t._v(" "),a("p",[t._v("这意味着每有一个新项目，就需要在gitlab，jenkins，k8s上新建对应的项目。")]),t._v(" "),a("p",[t._v("虽然每次配置只花10分钟，但这种重复的劳动终究不是我们想要的。")]),t._v(" "),a("p",[t._v("仔细一看，发现每次新建项目基本是改下名字，其他配置都没怎么改过，于是便有了改造思路：")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("去掉中间商jenkins（jenkins是很优秀的，这里不用它是为了偷懒）")])]),t._v(" "),a("li",[a("p",[t._v("利用gitlab的runner来做CI/CD")])])]),t._v(" "),a("h2",{attrs:{id:"ci-cd-流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ci-cd-流程"}},[t._v("#")]),t._v(" CI/CD 流程")]),t._v(" "),a("p",[t._v("去掉jenkins后，代码的打包发布工作就交给了gitlab的Runner。")]),t._v(" "),a("p",[t._v("Runner是一个干活的，整个流程如下：")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("提交代码 -> 触发 gitlab Runner \n            -> 打包代码\n                      -> 发布\n")])])]),a("p",[t._v("代码提交后，Runner会根据.gitlab-ci.yml的配置来工作，该打包的打包，该发布的发布。")]),t._v(" "),a("p",[t._v("这里有个问题：怎么区分不同的环境呢？")]),t._v(" "),a("p",[t._v("我们的做法是把环境和分支结合在一起。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("分支名")]),t._v(" "),a("th",[t._v("环境")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("dev")]),t._v(" "),a("td",[t._v("开发环境")])]),t._v(" "),a("tr",[a("td",[t._v("test")]),t._v(" "),a("td",[t._v("测试环境")])]),t._v(" "),a("tr",[a("td",[t._v("release")]),t._v(" "),a("td",[t._v("正式环境")])])])]),t._v(" "),a("p",[t._v("在对应分支上提交代码，Runner会自动打包到对应的环境中。")]),t._v(" "),a("h2",{attrs:{id:"runner使用示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#runner使用示例"}},[t._v("#")]),t._v(" Runner使用示例")]),t._v(" "),a("p",[t._v("Runner的安装就不赘述了，可以用docker，可以放k8s里，也可以直接放某台服务器上。")]),t._v(" "),a("p",[t._v("我们的方案是：每个项目组都配置一个Runner，使用不同的.gitlab-ci.yml。")]),t._v(" "),a("h3",{attrs:{id:"前端gitlab-ci-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前端gitlab-ci-yml"}},[t._v("#")]),t._v(" 前端gitlab-ci.yml")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node_modules "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 缓存 node_modules")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" install\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("install")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" install\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" release \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" yarn config set registry http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("//registry.npm.taobao.org/\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" yarn\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" release\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" yarn build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("artifacts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" dist\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" release\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" python3 /opt/script/oss.py `pwd`/dist  $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_PROJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_COMMIT_REF_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("说明：")]),t._v(" "),a("ol",[a("li",[t._v("在deploy阶段，脚本oss.py会根据变量CI_PROJECT_NAME和CI_COMMIT_REF_NAME，把代码发布到对应的环境中。")])]),t._v(" "),a("h3",{attrs:{id:"后端gitlab-ci-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#后端gitlab-ci-yml"}},[t._v("#")]),t._v(" 后端gitlab-ci.yml")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DOCKER_REGISTRY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'registry.cn-shenzhen.aliyuncs.com'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker镜像仓库地址")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("DOCKER_NAMESAPCE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'xxxxx'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# docker镜像仓库名")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" release\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" TAG=`python3 /opt/script/get_docker_tag.py $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_PROJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_COMMIT_REF_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("`\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" DOCKER_TAG=$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_COMMIT_REF_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' echo "DOCKER_TAG=$'),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('" '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" build.env\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_PROJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" .\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker tag $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_PROJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_REGISTRY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_NAMESAPCE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_PROJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker push $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_REGISTRY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_NAMESAPCE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("/$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_PROJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("$"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("artifacts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("reports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dotenv")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build.env\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" release\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" python3 /opt/script/k8s.py $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("CI_PROJECT_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" $"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("DOCKER_TAG"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dependencies")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n\n")])])]),a("p",[t._v("说明：")]),t._v(" "),a("p",[t._v("1.为了使docker镜像的tag好看一点，写了个get_docker_tag.py脚本来产生自增id，和变量CI_COMMIT_REF_NAME组合成一个tag变量DOCKER_TAG，比如会是test1, release2这样的。")]),t._v(" "),a("p",[t._v("2.在deploy阶段，脚本k8s.py会根据变量CI_PROJECT_NAME和DOCKER_TAG，在k8s上创建或更新应用。")])])}),[],!1,null,null,null);s.default=e.exports}}]);