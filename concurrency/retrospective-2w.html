<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一次小并发的上线复盘 | 小小郭的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="小小郭">
    <link rel="preload" href="/assets/css/0.styles.f333096b.css" as="style"><link rel="preload" href="/assets/js/app.158714e6.js" as="script"><link rel="preload" href="/assets/js/2.a806d99a.js" as="script"><link rel="preload" href="/assets/js/10.ceb6da30.js" as="script"><link rel="prefetch" href="/assets/js/11.f6fcdde7.js"><link rel="prefetch" href="/assets/js/12.c1ccc7c5.js"><link rel="prefetch" href="/assets/js/13.2e80b5f4.js"><link rel="prefetch" href="/assets/js/14.86580eea.js"><link rel="prefetch" href="/assets/js/15.ec8bc9ac.js"><link rel="prefetch" href="/assets/js/16.ffe6c259.js"><link rel="prefetch" href="/assets/js/17.f11cefb5.js"><link rel="prefetch" href="/assets/js/18.ba7fa50a.js"><link rel="prefetch" href="/assets/js/19.d98194cd.js"><link rel="prefetch" href="/assets/js/20.b3e3e3ba.js"><link rel="prefetch" href="/assets/js/21.0560925d.js"><link rel="prefetch" href="/assets/js/22.151f504b.js"><link rel="prefetch" href="/assets/js/23.c0dd585a.js"><link rel="prefetch" href="/assets/js/24.5ac8c4b5.js"><link rel="prefetch" href="/assets/js/25.57989e7c.js"><link rel="prefetch" href="/assets/js/26.19ae4c70.js"><link rel="prefetch" href="/assets/js/27.7b7a4013.js"><link rel="prefetch" href="/assets/js/28.c02de8fb.js"><link rel="prefetch" href="/assets/js/29.be98b5ac.js"><link rel="prefetch" href="/assets/js/3.f9a5341d.js"><link rel="prefetch" href="/assets/js/30.151ce4ad.js"><link rel="prefetch" href="/assets/js/31.e3b05220.js"><link rel="prefetch" href="/assets/js/32.48233f51.js"><link rel="prefetch" href="/assets/js/33.cdf1ba85.js"><link rel="prefetch" href="/assets/js/34.8e175bdf.js"><link rel="prefetch" href="/assets/js/35.53e76add.js"><link rel="prefetch" href="/assets/js/36.2588db5d.js"><link rel="prefetch" href="/assets/js/37.904d3476.js"><link rel="prefetch" href="/assets/js/38.1424f189.js"><link rel="prefetch" href="/assets/js/39.0e05003b.js"><link rel="prefetch" href="/assets/js/4.84d9a9b8.js"><link rel="prefetch" href="/assets/js/40.e4b36098.js"><link rel="prefetch" href="/assets/js/41.13258ed7.js"><link rel="prefetch" href="/assets/js/42.6f5a7cbb.js"><link rel="prefetch" href="/assets/js/43.7898149d.js"><link rel="prefetch" href="/assets/js/44.37b08732.js"><link rel="prefetch" href="/assets/js/45.17998593.js"><link rel="prefetch" href="/assets/js/46.055bc79a.js"><link rel="prefetch" href="/assets/js/47.6df10fa7.js"><link rel="prefetch" href="/assets/js/48.2660180a.js"><link rel="prefetch" href="/assets/js/49.4625a12a.js"><link rel="prefetch" href="/assets/js/5.501f4465.js"><link rel="prefetch" href="/assets/js/50.b3b348da.js"><link rel="prefetch" href="/assets/js/51.dcb3be6c.js"><link rel="prefetch" href="/assets/js/52.7dd04b5b.js"><link rel="prefetch" href="/assets/js/53.20259b4b.js"><link rel="prefetch" href="/assets/js/54.c876d67f.js"><link rel="prefetch" href="/assets/js/55.52c8359c.js"><link rel="prefetch" href="/assets/js/56.ab71b89a.js"><link rel="prefetch" href="/assets/js/57.30af5fe9.js"><link rel="prefetch" href="/assets/js/58.d1f3acb8.js"><link rel="prefetch" href="/assets/js/59.0c65a864.js"><link rel="prefetch" href="/assets/js/6.56baaf4e.js"><link rel="prefetch" href="/assets/js/60.cc2dc3eb.js"><link rel="prefetch" href="/assets/js/61.bc3d577e.js"><link rel="prefetch" href="/assets/js/62.88dedbc6.js"><link rel="prefetch" href="/assets/js/63.5403d296.js"><link rel="prefetch" href="/assets/js/64.cdcabf93.js"><link rel="prefetch" href="/assets/js/65.7fba108e.js"><link rel="prefetch" href="/assets/js/66.51641258.js"><link rel="prefetch" href="/assets/js/67.f408a0b2.js"><link rel="prefetch" href="/assets/js/68.326016eb.js"><link rel="prefetch" href="/assets/js/69.9dde49ee.js"><link rel="prefetch" href="/assets/js/7.86ee5bb7.js"><link rel="prefetch" href="/assets/js/70.76be6feb.js"><link rel="prefetch" href="/assets/js/71.8bb3d5a3.js"><link rel="prefetch" href="/assets/js/72.3d340b56.js"><link rel="prefetch" href="/assets/js/73.94ae8b58.js"><link rel="prefetch" href="/assets/js/74.c38b2bf5.js"><link rel="prefetch" href="/assets/js/75.ab88131c.js"><link rel="prefetch" href="/assets/js/76.b15fc67e.js"><link rel="prefetch" href="/assets/js/8.77896323.js"><link rel="prefetch" href="/assets/js/9.1bb7c316.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f333096b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小小郭的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">
  关于我
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一次小并发的上线复盘"><a href="#一次小并发的上线复盘" class="header-anchor">#</a> 一次小并发的上线复盘</h1> <p>由于有的人喜欢说高并发，百万并发，所以这个2万并发的项目就叫小并发吧。</p> <h2 id="开发阶段"><a href="#开发阶段" class="header-anchor">#</a> 开发阶段</h2> <p>之前给客户A做过一个活动，当时说活动会有1万并发，我们做了大量的优化和准备，结果上线后并发只有2千多，这个数据让我们觉得客户A喜欢吹牛。</p> <p>几个月后客户A又找过来，说要做一个新的活动，称这个活动会有2万的并发。由于之前的&quot;经验&quot;，我们觉得顶多也就3千多吧，于是开发时就比较放飞。比如核心字段用TEXT，取全表数据来排名，用了大量的MySQL等等，这些设计给后面的上线埋下了小地雷。</p> <p>在上线前做了几次压测，压测目标2万，结果也还行，错误率0.04%，大家觉得OK了，没问题，上线吧。但这里压测的是开发单独给的版本，和正式版相比少了一些SQL操作，这里也是一个小地雷。</p> <h2 id="上线当天"><a href="#上线当天" class="header-anchor">#</a> 上线当天</h2> <p>上线后客户A开始推活动，开始的几分钟还正常，活动能正常进入，礼品可以正常结算。但过了几分钟后，页面开始白屏，接口一直是pending状态，客户问到：&quot;不是说性能没问题吗，怎么都进不去了，我的推广浪费啦&quot;。场面开始尴尬，测试开始沉默，开发开始沉默，运维开始沉默，场面开始沉默，空气非常安静。</p> <h2 id="找瓶颈"><a href="#找瓶颈" class="header-anchor">#</a> 找瓶颈</h2> <p>沉默只是再别的康桥，不是解决问题的法宝。客户的活动还要继续，怎么办？撸起袖子开始优化吧。</p> <p>先看一下整个活动的流量走向。</p> <p><strong>南北流量：</strong></p> <p><code>用户 -&gt; SLB -&gt; K8S Ingress -&gt; K8S SVC -&gt; K8S node 应用</code></p> <p><strong>东西流量：</strong></p> <p><code>K8S node 应用 -&gt; Redis</code></p> <p><code>K8S node 应用 -&gt; MySQL</code></p> <p><code>K8S node 应用 -&gt; 第三方接口</code></p> <p>整个架构很单纯，看下链条中的各个节点的性能吧，找出有瓶颈节点。</p> <p>通过看监控数据，发现MySQL和Redis都有瓶颈，它们的CPU都到了100%，其他都正常。</p> <h2 id="开始优化"><a href="#开始优化" class="header-anchor">#</a> 开始优化</h2> <h4 id="mysql优化"><a href="#mysql优化" class="header-anchor">#</a> MySQL优化</h4> <p><strong>1.升级配置</strong></p> <p>将MySQL迁移到了PolarDB上，由单点转为集群，硬件配置上也做了提升。这里的策略是先选个高配的，看能否顶住，之后再往下降配置，最终找到一个合适的配置。</p> <p><strong>2.找出慢SQL，优化SQL</strong></p> <p>直接看慢SQL查询即可，发现了几个问题：</p> <div class="language- extra-class"><pre class="language-text"><code>1.排行榜用了全表扫描，改为用redis有序集做排行榜。
2.有些SQL用了系统函数，比如DATE函数，全部去掉，改为用node计算（此次后端用node写的）。
3.有些地方没加索引，对应加上。
4.有的地方没做类型判断，会触发MySQL的隐形转换，比如查电话号码，应该是 phone = '13412341234' ， 而不是 phone = 13412341234
</code></pre></div><p><strong>3.减少同步写的操作，能改为异步的就异步</strong></p> <p>比如发礼物，可以直接改为用队列来做，将同步改为异步。</p> <h4 id="redis优化"><a href="#redis优化" class="header-anchor">#</a> redis优化</h4> <p><strong>1.升级配置</strong></p> <p>将Redis升级为集群版。</p> <p><strong>2.找出慢的redis查询</strong></p> <p>查看日志发现zrangebyscore指令很耗时，结合业务需求，在该指令中加上 limit 参数。</p> <h2 id="第二天推广"><a href="#第二天推广" class="header-anchor">#</a> 第二天推广</h2> <p>经过优化之后，MySQL和Redis的CPU利用率发生了明显的下降：</p> <p>MySQL的CPU负载：</p> <p><img src="https://img.xiaoxiaoguo.cn/usr/uploads/2020/05/545719797.png" alt="mysqlGM.png"></p> <p>Redis的CPU负载：</p> <p><img src="https://img.xiaoxiaoguo.cn/usr/uploads/2020/05/372968294.png" alt="RedisGM.png"></p> <p>经过这些优化后，效果显著，轻松的抗住了客户A第二天的推广。客户表示满意，测试舒了口气，开发舒了口气，运维舒了口气，空气变得活泼了，故事到这里也就结束了。</p> <h2 id="异史氏曰"><a href="#异史氏曰" class="header-anchor">#</a> 异史氏曰</h2> <p>0.按照客户需求来做，不要侥幸。</p> <p>1.不管是大项目还是小项目，在开发时应该尽量规范，比如多遵守下前辈总结的MySQL经验。</p> <p>2.压测版本要一致，不要为了方便压测搞些特殊版本。</p> <p>3.在大并发的场景下，流量是瞬间打上来的，给你调整配置的时间很短，如果你的配置顶不住，那么一瞬间就会奔溃。所以先按压测配置的双倍或多倍来扩容好服务器，数据库等配置，可以上线后看使用情况再来缩减配置。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div> <footer><div style="text-align: center;">
            © 2020 小小郭的博客
            <a href="http://www.beian.miit.gov.cn/">粤ICP备16016910号</a> <br><br></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.158714e6.js" defer></script><script src="/assets/js/2.a806d99a.js" defer></script><script src="/assets/js/10.ceb6da30.js" defer></script>
  </body>
</html>
