<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>支付宝支付和微信支付的服务端签名 | 小小郭的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="小小郭">
    <link rel="preload" href="/assets/css/0.styles.f333096b.css" as="style"><link rel="preload" href="/assets/js/app.158714e6.js" as="script"><link rel="preload" href="/assets/js/2.a806d99a.js" as="script"><link rel="preload" href="/assets/js/48.2660180a.js" as="script"><link rel="prefetch" href="/assets/js/10.ceb6da30.js"><link rel="prefetch" href="/assets/js/11.f6fcdde7.js"><link rel="prefetch" href="/assets/js/12.c1ccc7c5.js"><link rel="prefetch" href="/assets/js/13.2e80b5f4.js"><link rel="prefetch" href="/assets/js/14.86580eea.js"><link rel="prefetch" href="/assets/js/15.ec8bc9ac.js"><link rel="prefetch" href="/assets/js/16.ffe6c259.js"><link rel="prefetch" href="/assets/js/17.f11cefb5.js"><link rel="prefetch" href="/assets/js/18.ba7fa50a.js"><link rel="prefetch" href="/assets/js/19.d98194cd.js"><link rel="prefetch" href="/assets/js/20.b3e3e3ba.js"><link rel="prefetch" href="/assets/js/21.0560925d.js"><link rel="prefetch" href="/assets/js/22.151f504b.js"><link rel="prefetch" href="/assets/js/23.c0dd585a.js"><link rel="prefetch" href="/assets/js/24.5ac8c4b5.js"><link rel="prefetch" href="/assets/js/25.57989e7c.js"><link rel="prefetch" href="/assets/js/26.19ae4c70.js"><link rel="prefetch" href="/assets/js/27.7b7a4013.js"><link rel="prefetch" href="/assets/js/28.c02de8fb.js"><link rel="prefetch" href="/assets/js/29.be98b5ac.js"><link rel="prefetch" href="/assets/js/3.f9a5341d.js"><link rel="prefetch" href="/assets/js/30.151ce4ad.js"><link rel="prefetch" href="/assets/js/31.e3b05220.js"><link rel="prefetch" href="/assets/js/32.48233f51.js"><link rel="prefetch" href="/assets/js/33.cdf1ba85.js"><link rel="prefetch" href="/assets/js/34.8e175bdf.js"><link rel="prefetch" href="/assets/js/35.53e76add.js"><link rel="prefetch" href="/assets/js/36.2588db5d.js"><link rel="prefetch" href="/assets/js/37.904d3476.js"><link rel="prefetch" href="/assets/js/38.1424f189.js"><link rel="prefetch" href="/assets/js/39.0e05003b.js"><link rel="prefetch" href="/assets/js/4.84d9a9b8.js"><link rel="prefetch" href="/assets/js/40.e4b36098.js"><link rel="prefetch" href="/assets/js/41.13258ed7.js"><link rel="prefetch" href="/assets/js/42.6f5a7cbb.js"><link rel="prefetch" href="/assets/js/43.7898149d.js"><link rel="prefetch" href="/assets/js/44.37b08732.js"><link rel="prefetch" href="/assets/js/45.17998593.js"><link rel="prefetch" href="/assets/js/46.055bc79a.js"><link rel="prefetch" href="/assets/js/47.6df10fa7.js"><link rel="prefetch" href="/assets/js/49.4625a12a.js"><link rel="prefetch" href="/assets/js/5.501f4465.js"><link rel="prefetch" href="/assets/js/50.b3b348da.js"><link rel="prefetch" href="/assets/js/51.dcb3be6c.js"><link rel="prefetch" href="/assets/js/52.7dd04b5b.js"><link rel="prefetch" href="/assets/js/53.20259b4b.js"><link rel="prefetch" href="/assets/js/54.c876d67f.js"><link rel="prefetch" href="/assets/js/55.52c8359c.js"><link rel="prefetch" href="/assets/js/56.ab71b89a.js"><link rel="prefetch" href="/assets/js/57.30af5fe9.js"><link rel="prefetch" href="/assets/js/58.d1f3acb8.js"><link rel="prefetch" href="/assets/js/59.0c65a864.js"><link rel="prefetch" href="/assets/js/6.56baaf4e.js"><link rel="prefetch" href="/assets/js/60.cc2dc3eb.js"><link rel="prefetch" href="/assets/js/61.bc3d577e.js"><link rel="prefetch" href="/assets/js/62.88dedbc6.js"><link rel="prefetch" href="/assets/js/63.5403d296.js"><link rel="prefetch" href="/assets/js/64.cdcabf93.js"><link rel="prefetch" href="/assets/js/65.7fba108e.js"><link rel="prefetch" href="/assets/js/66.51641258.js"><link rel="prefetch" href="/assets/js/67.f408a0b2.js"><link rel="prefetch" href="/assets/js/68.326016eb.js"><link rel="prefetch" href="/assets/js/69.9dde49ee.js"><link rel="prefetch" href="/assets/js/7.86ee5bb7.js"><link rel="prefetch" href="/assets/js/70.76be6feb.js"><link rel="prefetch" href="/assets/js/71.8bb3d5a3.js"><link rel="prefetch" href="/assets/js/72.3d340b56.js"><link rel="prefetch" href="/assets/js/73.94ae8b58.js"><link rel="prefetch" href="/assets/js/74.c38b2bf5.js"><link rel="prefetch" href="/assets/js/75.ab88131c.js"><link rel="prefetch" href="/assets/js/76.b15fc67e.js"><link rel="prefetch" href="/assets/js/8.77896323.js"><link rel="prefetch" href="/assets/js/9.1bb7c316.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f333096b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小小郭的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">
  关于我
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="支付宝支付和微信支付的服务端签名"><a href="#支付宝支付和微信支付的服务端签名" class="header-anchor">#</a> 支付宝支付和微信支付的服务端签名</h1> <p>这两天做了下APP支付的服务端签名，记下流水账。</p> <h2 id="一-支付流程"><a href="#一-支付流程" class="header-anchor">#</a> 一.支付流程</h2> <p>简单归纳下主要流程，详细请看微信和支付宝的开发文档</p> <p><img src="https://img.xiaoxiaoguo.cn/usr/uploads/2018/06/2914045789.png" alt=""></p> <h2 id="二-资料准备"><a href="#二-资料准备" class="header-anchor">#</a> 二.资料准备</h2> <h3 id="支付宝"><a href="#支付宝" class="header-anchor">#</a> 支付宝</h3> <p>1.登录https://open.alipay.com/platform/manageHome.htm，创建一个应用，设置好自己的私钥和公钥</p> <p><img src="https://img.xiaoxiaoguo.cn/usr/uploads/2018/06/442030364.png" alt=""></p> <p>2.将该应用上线，签约其中的APP支付功能。为了便于测试，将手机网站支付，电脑网站支付也签约加上</p> <p><img src="https://img.xiaoxiaoguo.cn/usr/uploads/2018/06/3974453951.png" alt=""></p> <h3 id="微信"><a href="#微信" class="header-anchor">#</a> 微信</h3> <p>1.登录微信开发者中心https://open.weixin.qq.com，创建一个应用</p> <p>2.将该应用上线，开通微信支付功能</p> <p>3.登录微信支付https://pay.weixin.qq.com，记录下appid，mchid</p> <h3 id="sdk"><a href="#sdk" class="header-anchor">#</a> SDK</h3> <p>开发调试时使用的sdk https://github.com/yansongda/pay</p> <h2 id="三-服务端签名"><a href="#三-服务端签名" class="header-anchor">#</a> 三.服务端签名</h2> <h3 id="支付宝-2"><a href="#支付宝-2" class="header-anchor">#</a> 支付宝</h3> <p><strong>1. 签名</strong></p> <p>使用支付宝的官方sdk，RSA2签名</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$Client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>AopClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//实例化支付宝sdk里面的AopClient类,下单时需要的操作,都在这个类里面</span>
<span class="token variable">$param</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'timestamp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Y-m-d Hi:i:s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送请求的时间</span>
<span class="token variable">$privateKey</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'ali.private_key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使用自己的私钥</span>
<span class="token variable">$paramStr</span> <span class="token operator">=</span> <span class="token variable">$Client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getSignContent</span><span class="token punctuation">(</span><span class="token variable">$param</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//组装请求签名参数</span>
<span class="token variable">$sign</span> <span class="token operator">=</span> <span class="token variable">$Client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">alonersaSign</span><span class="token punctuation">(</span><span class="token variable">$paramStr</span><span class="token punctuation">,</span> <span class="token variable">$privateKey</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'RSA2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//生成签名</span>
</code></pre></div><p><strong>2.回调</strong></p> <p>支付完成后，支付宝会结果发回给回调地址，之后服务端可以对结果做验证，以及一些业务逻辑处理</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">//获取返回结果</span>
<span class="token variable">$inputs</span> <span class="token operator">=</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$inputs</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">parse_str</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">,</span><span class="token variable">$inputs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$client</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>AopClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//验证签名</span>
<span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">alipayrsaPublicKey</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'ali.ali_public_key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注意，用阿里云的公钥</span>
<span class="token variable">$flag</span> <span class="token operator">=</span> <span class="token variable">$client</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">rsaCheckV1</span><span class="token punctuation">(</span><span class="token variable">$inputs</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token double-quoted-string string">&quot;RSA2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//验证失败</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$inputs</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'trade_status'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token single-quoted-string string">'TRADE_SUCCESS'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//交易失败</span>
<span class="token punctuation">}</span>

<span class="token comment">//做一些自己业务代码处理</span>

<span class="token comment">//处理完成之后，告诉支付宝成功结果</span>
<span class="token keyword">return</span> <span class="token single-quoted-string string">'success'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="微信-2"><a href="#微信-2" class="header-anchor">#</a> 微信</h3> <p><strong>1. 签名</strong></p> <p>微信目前可以用md5签名，流程如下</p> <div class="language- extra-class"><pre class="language-text"><code>第一步 将必要参数以键值对的格式（即key1=value1&amp;key2=value2…）拼接成字符串stringA
第二步 将stringA最后拼接上key得到stringSignTemp字符串，并对stringSignTemp进行MD5运算，再结果转换为大写，得到sign值
第三步 将必要参数和sign值组合，转成xml格式
</code></pre></div><p>必要参数中有个nonce_str值，需要一个随机值</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">getNonceStr</span><span class="token punctuation">(</span><span class="token variable">$length</span> <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$chars</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;abcdefghijklmnopqrstuvwxyz0123456789&quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$str</span> <span class="token operator">=</span><span class="token double-quoted-string string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$length</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span> <span class="token punctuation">)</span>  <span class="token punctuation">{</span>
        <span class="token variable">$str</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$chars</span><span class="token punctuation">,</span> <span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$chars</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$str</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>组合数组</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">genContent</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$stringToBeSigned</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token keyword">as</span> <span class="token variable">$k</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$k</span> <span class="token operator">==</span> <span class="token single-quoted-string string">'sign'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$k</span> <span class="token operator">==</span> <span class="token single-quoted-string string">'sign_type'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean constant">false</span> <span class="token operator">===</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">checkEmpty</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token double-quoted-string string">&quot;@&quot;</span> <span class="token operator">!=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$v</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token variable">$stringToBeSigned</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token double-quoted-string string">&quot;<span class="token interpolation"><span class="token variable">$k</span></span>&quot;</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;=&quot;</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;<span class="token interpolation"><span class="token variable">$v</span></span>&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token variable">$stringToBeSigned</span> <span class="token punctuation">.</span><span class="token operator">=</span> <span class="token double-quoted-string string">&quot;&amp;&quot;</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;<span class="token interpolation"><span class="token variable">$k</span></span>&quot;</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;=&quot;</span> <span class="token punctuation">.</span> <span class="token double-quoted-string string">&quot;<span class="token interpolation"><span class="token variable">$v</span></span>&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">unset</span> <span class="token punctuation">(</span><span class="token variable">$k</span><span class="token punctuation">,</span> <span class="token variable">$v</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$stringToBeSigned</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>MD5签名</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">wxMd5</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//获取微信支付秘钥</span>
    <span class="token variable">$key</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'payment.wx.key'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    <span class="token comment">//去空</span>
    <span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">array_filter</span><span class="token punctuation">(</span><span class="token variable">$params</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//签名步骤一：按字典序排序参数</span>
    <span class="token function">ksort</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$string_a</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">genContent</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//按要求对数组进行组合</span>
    <span class="token variable">$string_a</span> <span class="token operator">=</span> <span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$string_a</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//签名步骤二：在string后加入KEY</span>
    <span class="token variable">$string_sign_temp</span> <span class="token operator">=</span> <span class="token variable">$string_a</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&amp;key=&quot;</span><span class="token punctuation">.</span><span class="token variable">$key</span><span class="token punctuation">;</span>
    <span class="token comment">//签名步骤三：MD5加密</span>
    <span class="token variable">$sign</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$string_sign_temp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 签名步骤四：所有字符转为大写</span>
    <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$sign</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$result</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>返回xml结果</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$xml</span> <span class="token operator">=</span> <span class="token double-quoted-string string">&quot;&lt;xml&gt;&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$params</span> <span class="token keyword">as</span> <span class="token variable">$key</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_array</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token variable">$xml</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;&lt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$key</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&gt;&quot;</span><span class="token punctuation">.</span><span class="token function">arrayToXml</span><span class="token punctuation">(</span><span class="token variable">$val</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;/&quot;</span><span class="token punctuation">.</span><span class="token variable">$key</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&gt;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token variable">$xml</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;&lt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$key</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&gt;&quot;</span><span class="token punctuation">.</span><span class="token variable">$val</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&lt;/&quot;</span><span class="token punctuation">.</span><span class="token variable">$key</span><span class="token punctuation">.</span><span class="token double-quoted-string string">&quot;&gt;&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$xml</span><span class="token punctuation">.</span><span class="token operator">=</span><span class="token double-quoted-string string">&quot;&lt;/xml&gt;&quot;</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>2.回调</strong>
支付完成后，微信也会发送支付结果给回调地址，和支付宝一样，只是获取方式不同，字段有些不同，返回确认的字符不一样。</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">//获取返回结果</span>
<span class="token variable">$xmlData</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">libxml_disable_entity_loader</span><span class="token punctuation">(</span><span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$inputs</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token function">simplexml_load_string</span><span class="token punctuation">(</span><span class="token variable">$xmlData</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'SimpleXMLElement'</span><span class="token punctuation">,</span> <span class="token constant">LIBXML_NOCDATA</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean constant">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//验证签名</span>

<span class="token comment">//校验md5值</span>
<span class="token variable">$sign</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">wxMd5</span><span class="token punctuation">(</span><span class="token variable">$inputs</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$sign</span> <span class="token operator">!=</span> <span class="token variable">$inputs</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'sign'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">//验证失败,md5值不相等</span>
<span class="token punctuation">}</span>

<span class="token comment">//验证支付状态</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$inputs</span><span class="token punctuation">[</span><span class="token single-quoted-string string">'result_code'</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token single-quoted-string string">'SUCCESS'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token comment">//交易失败</span>
<span class="token punctuation">}</span>

<span class="token comment">//做一些自己业务代码处理</span>

<span class="token comment">//处理完成之后，告诉微信成功结果</span>
<span class="token keyword">return</span> <span class="token single-quoted-string string">'&lt;xml&gt;
    &lt;return_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/return_code&gt;
    &lt;return_msg&gt;&lt;![CDATA[OK]]&gt;&lt;/return_msg&gt;
&lt;/xml&gt;'</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div> <footer><div style="text-align: center;">
            © 2020 小小郭的博客
            <a href="http://www.beian.miit.gov.cn/">粤ICP备16016910号</a> <br><br></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.158714e6.js" defer></script><script src="/assets/js/2.a806d99a.js" defer></script><script src="/assets/js/48.2660180a.js" defer></script>
  </body>
</html>
