(window.webpackJsonp=window.webpackJsonp||[]).push([[35],{386:function(e,n,t){"use strict";t.r(n);var a=t(26),s=Object(a.a)({},(function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[t("h1",{attrs:{id:"使用openvpn连通多个机房内网"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用openvpn连通多个机房内网"}},[e._v("#")]),e._v(" 使用openvpn连通多个机房内网")]),e._v(" "),t("h2",{attrs:{id:"一-环境简述"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#一-环境简述"}},[e._v("#")]),e._v(" 一.环境简述")]),e._v(" "),t("p",[e._v("之前一直使用公网ip来连接各个机房的服务器,现在ip不太够用了,而且有些机器也不需要用到公网ip.通过openvpn将多个机房连接起来,组成一个局域网,机器ip可以做到唯一性,便于标识.既节省了ip.又方便管理.")]),e._v(" "),t("p",[e._v("本例环境如下,服务器使用的系统为centos 7.1")]),e._v(" "),t("p",[t("img",{attrs:{src:"https://img.xiaoxiaoguo.cn/usr/uploads/2017/07/738096363.jpg",alt:"openvpn.jpg"}})]),e._v(" "),t("p",[e._v("北京机房内网网段 172.16.2.0/24,服务器公网ip 20.20.20.20,内网网关172.16.2.1")]),e._v(" "),t("p",[e._v("广州机房内网网段 172.16.1.0/24,服务器公网ip 10.10.10.10,内网网关172.16.1.1")]),e._v(" "),t("p",[e._v("公司内网网段 172.16.3.0/24,防火墙公网ip 30.30.30.30,内网网关172.16.3.1,内网服务器ip 172.16.3.88")]),e._v(" "),t("p",[e._v("实现思路:")]),e._v(" "),t("p",[e._v("1.在广州机房搭建一个openvpn服务端,北京和公司内网各选一台服务器做openvpn的客户端连接广州.")]),e._v(" "),t("p",[e._v("2.openvpn使用桥接模式,开启client-to-client.北京和公司都连上后,这3台机器默认就能互访.")]),e._v(" "),t("p",[e._v("3.各内网网段的互通使用静态路由.")]),e._v(" "),t("h2",{attrs:{id:"二-广州安装openvpn服务端"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#二-广州安装openvpn服务端"}},[e._v("#")]),e._v(" 二.广州安装openvpn服务端")]),e._v(" "),t("p",[e._v("安装前需注意服务器的系统时间要一致,可按如下方法同步:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("/usr/sbin/ntpdate cn.pool.ntp.org\n")])])]),t("h3",{attrs:{id:"_1-安装openvpn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装openvpn"}},[e._v("#")]),e._v(" 1.安装openvpn")]),e._v(" "),t("p",[e._v("如果没epel源,先添加下")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("wget  http://dl.fedoraproject.org/pub/epel/7/x86_64/e/epel-release-7-5.noarch.rpm\nrpm -Uvh epel-release-7-5.noarch.rpm\nyum -y install openvpn easy-rsa \n")])])]),t("h3",{attrs:{id:"_2-创建证书"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建证书"}},[e._v("#")]),e._v(" 2.创建证书")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cp -r /usr/share/easy-rsa/ /etc/openvpn/\ncd /etc/openvpn/easy-rsa/2.*/\n")])])]),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("vim vars\n")])])]),t("p",[e._v("设置如下内容")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('export KEY_COUNTRY="CN"\nexport KEY_PROVINCE="GD"\nexport KEY_CITY="guangzhou"\nexport KEY_ORG="test"\nexport KEY_EMAIL="me@myhost.mydomain"\nexport KEY_OU="MyOrganizationalUnit"\n# X509 Subject Field\nexport KEY_NAME="EasyRSA"\n')])])]),t("p",[e._v("产生证书")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("source ./vars\n./clean-all\n./build-ca\n\n./build-key-server server\n./build-dh\n./build-key client\n\ncd /etc/openvpn/easy-rsa/2.0/\ncp -r keys/ /etc/openvpn/\n")])])]),t("h3",{attrs:{id:"_3-配置openvpn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-配置openvpn"}},[e._v("#")]),e._v(" 3.配置openvpn")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("vim /etc/openvpn/server.conf\n")])])]),t("p",[e._v("关键配置如下:")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("port 1194\nproto udp\ndev tap0\nca /etc/openvpn/keys/ca.crt\ncert /etc/openvpn/keys/server.crt\nkey /etc/openvpn/keys/server.key\ndh /etc/openvpn/keys/dh2048.pem\nifconfig-pool-persist ipp.txt\nserver-bridge 172.16.1.1 255.255.255.0 172.16.1.2 172.16.1.10\nclient-config-dir ccd\nclient-to-client\nduplicate-cn\nkeepalive 10 120\ncomp-lzo\nuser nobody\ngroup nobody\npersist-key\npersist-tun\nstatus openvpn-status.log\nverb 4\nmute 20\nscript-security 3 \n#验证用户名密码脚本\nauth-user-pass-verify /etc/openvpn/checkpsw.sh via-env \n#开启用户名和密码验证,用于服务端分配固定ip\nusername-as-common-name\nclient-config-dir /etc/openvpn/ccd #用于服务端分配固定ip\n")])])]),t("p",[e._v("设置用户名和密码，并设置固定分配ip")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cd /etc/openvpn\nvim psw-file\n#这里设置用于连接openvpn的用户名和密码,格式为用户名 + 空格 +密码，例如\nbj test123456\ncom test123456\n\n#在该目录下再新建一个ccd文件夹\nmkdir ccd\ncd ccd\n\n#在该目录下新建两个文件，把用户名作为文件名的命名\n\nvi bj\n#添加如下内容\nifconfig-push 172.16.1.2 255.255.255.0\n\nvi com\n#添加如下内容\nifconfig-push 172.16.1.3 255.255.255.0\n")])])]),t("h3",{attrs:{id:"４-添加密码验证脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#４-添加密码验证脚本"}},[e._v("#")]),e._v(" ４.添加密码验证脚本")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("vi /etc/openvpn/checkpsw.sh\n")])])]),t("p",[e._v("内容如下")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('#!/bin/sh\n###########################################################\n# checkpsw.sh (C) 2004 Mathias Sundman <mathias@openvpn.se>\n#\n# This script will authenticate OpenVPN users against\n# a plain text file. The passfile should simply contain\n# one row per user with the username first followed by\n# one or more space(s) or tab(s) and then the password.\n\nPASSFILE="/etc/openvpn/psw-file"\nLOG_FILE="/var/log/openvpn-password.log"\nTIME_STAMP=`date "+%Y-%m-%d %T"`\n\n###########################################################\n\nif [ ! -r "${PASSFILE}" ]; then\n  echo "${TIME_STAMP}: Could not open password file \\"${PASSFILE}\\" for reading." >> ${LOG_FILE}\n  exit 1\nfi\n\nCORRECT_PASSWORD=`awk \'!/^;/&&!/^#/&&$1=="\'${username}\'"{print $2;exit}\' ${PASSFILE}`\n\nif [ "${CORRECT_PASSWORD}" = "" ]; then \n  echo "${TIME_STAMP}: User does not exist: username=\\"${username}\\", password=\\"${password}\\"." >> ${LOG_FILE}\n  exit 1\nfi\n\nif [ "${password}" = "${CORRECT_PASSWORD}" ]; then \n  echo "${TIME_STAMP}: Successful authentication: username=\\"${username}\\"." >> ${LOG_FILE}\n  exit 0\nfi\n\necho "${TIME_STAMP}: Incorrect password: username=\\"${username}\\", password=\\"${password}\\"." >> ${LOG_FILE}\nexit 1\n')])])]),t("h3",{attrs:{id:"_5-ip配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-ip配置"}},[e._v("#")]),e._v(" 5.IP配置")]),e._v(" "),t("p",[e._v("给openVPN服务端的网卡配置ip时，有两种方式选择：桥接或者在配置文件中设置，这里两种都示例下，选择任意一个即可，推荐用配置文件分配(简单些~)。")]),e._v(" "),t("h4",{attrs:{id:"_5-1-在配置文件中指定"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-在配置文件中指定"}},[e._v("#")]),e._v(" 5.1 在配置文件中指定")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("vim /etc/openvpn/server.conf\n")])])]),t("p",[e._v("在ifconfig-pool-persist ipp.txt下添加一行")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("ifconfig 172.16.1.1 255.255.255.0\n")])])]),t("h4",{attrs:{id:"_5-2-通过桥接分配"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-通过桥接分配"}},[e._v("#")]),e._v(" 5.2 通过桥接分配")]),e._v(" "),t("h5",{attrs:{id:"_5-2-1-启动桥接脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-1-启动桥接脚本"}},[e._v("#")]),e._v(" 5.2.1 启动桥接脚本")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('#!/bin/bash\n#################################\n# Set up Ethernet bridge on Linux\n# Requires: bridge-utils\n#################################\n# Define Bridge Interface\nbr="br0"\n# Define list of TAP interfaces to be bridged,\n# for example tap="tap0 tap1 tap2".\ntap="tap0"\n# Define physical ethernet interface to be bridged\n# with TAP interface(s) above.\neth="ens9" #这里注意下网卡名\neth_ip="172.16.1.1"\neth_netmask="255.255.255.0"\neth_broadcast="172.16.1.255"\nfor t in $tap; do\n   /usr/sbin/openvpn --mktun --dev $t\ndone\nbrctl addbr $br\nbrctl addif $br $eth\nfor t in $tap; do\n    brctl addif $br $t\ndone\nfor t in $tap; do\n    ifconfig $t 0.0.0.0 promisc up\ndone\nifconfig $eth 0.0.0.0 promisc up\nifconfig $br $eth_ip netmask $eth_netmask broadcast $eth_broadcast\nroute add -net 172.16.2.0/24 gw 172.16.1.2\nroute add -net 172.16.3.0/24 gw 172.16.1.3\n')])])]),t("h4",{attrs:{id:"_5-2-2-停止桥接脚本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-2-停止桥接脚本"}},[e._v("#")]),e._v(" 5.2.2 停止桥接脚本")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('#!/bin/bash\n####################################\n# Tear Down Ethernet bridge on Linux\n####################################\n# Define Bridge Interface\nbr="br0"\n# Define list of TAP interfaces to be bridged together\ntap="tap0"\nifconfig $br down\nbrctl delbr $br\nfor t in $tap; do\n    /usr/sbin/openvpn --rmtun --dev $t\ndone\n')])])]),t("h3",{attrs:{id:"_6-设置iptables"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-设置iptables"}},[e._v("#")]),e._v(" 6.设置iptables")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("nat链添加如下规则\n-A POSTROUTING -s 10.8.0.0/24 -o eth1 -j MASQUERADE\n-A POSTROUTING -s 172.16.0.0/16 -j MASQUERADE\n\nfilter链添加如下规则\n-A INPUT -s 20.20.20.0/24  -j ACCEPT\n-A INPUT -s ３0.３0.３0.0/24  -j ACCEPT\n-A INPUT -s 172.16.0.0/16 -j ACCEPT\n-A FORWARD -j ACCEPT\n")])])]),t("h3",{attrs:{id:"_7-启动openvpn"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-启动openvpn"}},[e._v("#")]),e._v(" 7.启动openvpn")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf\nsysctl -p\nsystemctl -f enable openvpn@server.service\nsystemctl start openvpn@server\n")])])]),t("h2",{attrs:{id:"三．北京-公司内网连接广州openvpn，打通内网"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#三．北京-公司内网连接广州openvpn，打通内网"}},[e._v("#")]),e._v(" 三．北京,公司内网连接广州openvpn，打通内网")]),e._v(" "),t("p",[e._v("以北京20.20.20.20服务器为例")]),e._v(" "),t("p",[e._v("１.安装openvpn,步骤同上")]),e._v(" "),t("p",[e._v("２.将openvpn服务端(10.10.10.10)的三个证书文件ca.crt  client.crt  client.key（路径/etc/openvpn/keys）拷贝到/etc/openvpn/下")]),e._v(" "),t("p",[e._v("３.添加openvpn启动脚本")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("cd /etc/openvpn\n\nvi client.sh\n＃添加如下内容\n#!/bin/sh\ncase \"$1\" in\nstart)\n    /usr/sbin/openvpn /etc/openvpn/client.ovpn > /dev/null &\n    sleep 5\n    route add -net 172.16.3.0/24 gw 172.16.1.3\n;;\nstop)\n    pkill openvpn\n;;\nrestart)\n    pkill openvpn\n    sleep 2\n    /usr/sbin/openvpn /etc/openvpn/client.ovpn > /dev/null &\n;;\nesac\n\nvi psw.conf\n＃添加如下内容\nbj\ntest123456\n\nvi client.ovpn\n#添加如下内容\nclient\ndev tap\nproto udp\nremote 10.10.10.10 1194\nresolv-retry infinite\nnobind\npersist-key\npersist-tun\nmute-replay-warnings\nca ca.crt\ncert client.crt\nkey client.key\nns-cert-type server\ncomp-lzo\nauth-user-pass psw.conf\n\n添加执行权限\nchmod +x client.sh\n\n＃加入系统启动项\necho '(cd /etc/openvpn; ./client.sh start)' >> /etc/rc.local\n")])])]),t("p",[e._v("4.设置iptables")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("nat链添加如下规则\n-A POSTROUTING -d 172.16.0.0/16 -o tap0 -j MASQUERADE\n\nfilter链添加如下规则\n-A FORWARD -i eth0 -o tap0 -j ACCEPT\n-A FORWARD -i tap0 -o eth0 -j ACCEPT\n")])])]),t("p",[e._v("５.设置完成后，重启下防火墙，启动openvpn")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("systemctl restart iptables\n(cd /etc/openvpn; ./client.sh start)\n\nping下广州内网网关172.16.1.1,如果ping通说明北京与广州可以互通了．\n＃ping 172.16.1.1 -c 4\nPING 172.16.1.1 (172.16.1.1) 56(84) bytes of data.\n64 bytes from 172.16.1.1: icmp_seq=1 ttl=64 time=37.1 ms\n64 bytes from 172.16.1.1: icmp_seq=2 ttl=64 time=37.0 ms\n64 bytes from 172.16.1.1: icmp_seq=3 ttl=64 time=37.2 ms\n64 bytes from 172.16.1.1: icmp_seq=4 ttl=64 time=37.0 ms\n\n--- 172.16.1.1 ping statistics ---\n4 packets transmitted, 4 received, 0% packet loss, time 3040ms\nrtt min/avg/max/mdev = 37.053/37.133/37.268/0.083 ms\n")])])]),t("p",[e._v("６.公司内网openvpn连接设置与北京一样，注意用户名密码及路由的不同：")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v('公司内网的openvpn的启动脚本如下：\nvi client.sh\n＃添加如下内容\n#!/bin/sh\ncase "$1" in\nstart)\n    /usr/sbin/openvpn /etc/openvpn/client.ovpn > /dev/null &\n    sleep 5\n    route add -net 172.16.２.0/24 gw 172.16.１.２\n;;\nstop)\n    pkill openvpn\n;;\nrestart)\n    pkill openvpn\n    sleep 2\n    /usr/sbin/openvpn /etc/openvpn/client.ovpn > /dev/null &\n;;\nesac\n')])])]),t("p",[e._v("7.北京，公司内网的openvpn都连接上后，在广州openvpn的服务器上添加如下路由")]),e._v(" "),t("div",{staticClass:"language- extra-class"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[e._v("route add -net 172.16.2.0/24 gw 172.16.1.2\nroute add -net 172.16.3.0/24 gw 172.16.1.3\n")])])]),t("p",[e._v("８.以上步骤成功完成后，北京内网，广州内网，公司内网即可互相访问．在任意的一台服务器上都可以访问其他节点的服务器，实现了内网互通的需求．")])])}),[],!1,null,null,null);n.default=s.exports}}]);