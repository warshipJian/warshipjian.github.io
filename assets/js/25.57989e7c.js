(window.webpackJsonp=window.webpackJsonp||[]).push([[25],{376:function(t,e,s){"use strict";s.r(e);var a=s(26),n=Object(a.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"守护进程-03-systemed"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#守护进程-03-systemed"}},[t._v("#")]),t._v(" 守护进程-03-systemed")]),t._v(" "),s("p",[t._v("看当前shell的pid")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("echo $$ \n")])])]),s("p",[t._v("看某个进程的pid可以用pidof，比如看nginx的")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("pidof nginx\n")])])]),s("p",[t._v("在"),s("code",[t._v("centos 6")]),t._v("时代我们要配置一个开机启动的程序时，可以在"),s("code",[t._v("/etc/rc.local")]),t._v("中添加启动命令，在"),s("code",[t._v("/etc/init.d")]),t._v("中添加启动脚本。到了"),s("code",[t._v("centos 7")]),t._v(" 时发现不推荐用"),s("code",[t._v("init")]),t._v("了，有了一个船新的系统systemed。")]),t._v(" "),s("h3",{attrs:{id:"systemed"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#systemed"}},[t._v("#")]),t._v(" systemed")]),t._v(" "),s("p",[t._v("还是拿之前的例子：")]),t._v(" "),s("div",{staticClass:"language-c extra-class"},[s("pre",{pre:!0,attrs:{class:"language-c"}},[s("code",[s("span",{pre:!0,attrs:{class:"token macro property"}},[t._v("#"),s("span",{pre:!0,attrs:{class:"token directive keyword"}},[t._v("include")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("<stdio.h>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" d "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("printf")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello %d \\n"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("d"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("fflush")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("stdout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        d "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("编译下得到a.out。")]),t._v(" "),s("p",[t._v("我们利用systemctl工具，将a.out添加到systemed系统中。")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("/lib/systemd/system")]),t._v("中创建一个文件"),s("code",[t._v("test-server.service")]),t._v("，内容如下：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("[Unit]\nDescription=my test service\n\n[Service]\nExecStart= /root/test/a.out\n\n[Install]\nWantedBy=multi-user.target\n")])])]),s("p",[t._v("通过"),s("code",[t._v("systemctl")]),t._v("命令启用它")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("root@lan-dev-215:~/test# systemctl enable /lib/systemd/system/test-server.service\nCreated symlink from /etc/systemd/system/multi-user.target.wants/test-server.service to /lib/systemd/system/test-server.service.\n")])])]),s("p",[t._v("此时看下它的状态")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("root@lan-dev-215:~/test# systemctl status test-server\n● test-server.service - my test service\n   Loaded: loaded (/lib/systemd/system/test-server.service; enabled; vendor preset: enabled)\n   Active: inactive (dead)\n")])])]),s("p",[t._v("启动")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("systemctl start test-server\n")])])]),s("p",[t._v("再看下它的状态")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("root@lan-dev-215:~/test# systemctl status test-server\n● test-server.service - my test service\n   Loaded: loaded (/lib/systemd/system/test-server.service; enabled; vendor preset: enabled)\n   Active: active (running) since Fri 2020-01-31 21:09:01 CST; 3s ago\n Main PID: 5110 (a.out)\n    Tasks: 1\n   Memory: 188.0K\n      CPU: 2ms\n   CGroup: /system.slice/test-server.service\n           └─5110 /root/test/a.out\n\nJan 31 21:09:01 lan-dev-215 systemd[1]: Started my test service.\nJan 31 21:09:01 lan-dev-215 a.out[5110]: hello 1\nJan 31 21:09:02 lan-dev-215 a.out[5110]: hello 2\nJan 31 21:09:03 lan-dev-215 a.out[5110]: hello 3\nJan 31 21:09:04 lan-dev-215 a.out[5110]: hello 4\n")])])]),s("p",[t._v("可以看到正常运行了。")]),t._v(" "),s("h3",{attrs:{id:"systemed-service-配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#systemed-service-配置文件"}},[t._v("#")]),t._v(" systemed.service 配置文件")]),t._v(" "),s("p",[t._v("主要是三部分：[Unit]， [Service]，[Install]。\n简单介绍下:\n"),s("strong",[t._v("[Unit]")]),t._v("\n主要是对这个服务的说明，内容， 文档介绍以及对一些依赖服务定义\n"),s("strong",[t._v("[Service]")]),t._v("\n服务的主体定义，主要定义服务的一些运行参数，及操作动作\n"),s("strong",[t._v("[Install]")]),t._v("\n服务安装的相关设置，一般可设置为多用户的\n更多在这里：https://www.freedesktop.org/software/systemd/man/systemd.service.html")]),t._v(" "),s("p",[t._v("这里关注Service中的Restart参数。\nRestart有这些值：always（总是重启）、no 、on-success、on-failure、on-abnormal、on-abort、on-watchdog\n每个值对应支持的事件如下：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("Restart settings/Exit causes")]),t._v(" "),s("th",[t._v("no")]),t._v(" "),s("th",[t._v("always")]),t._v(" "),s("th",[t._v("on-success")]),t._v(" "),s("th",[t._v("on-failure")]),t._v(" "),s("th",[t._v("on-abnormal")]),t._v(" "),s("th",[t._v("on-abort")]),t._v(" "),s("th",[t._v("on-watchdog")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("Clean exit code or signal")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td"),t._v(" "),s("td"),t._v(" "),s("td"),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("Unclean exit code")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td"),t._v(" "),s("td"),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("Unclean signal")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("Timeout")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td"),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td",[t._v("Watchdog")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td",[t._v("X")]),t._v(" "),s("td"),t._v(" "),s("td",[t._v("X")])])])]),t._v(" "),s("p",[t._v("回到刚才的service配置文件，里面没有Restart参数，我们去kill一下看看：")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("root@lan-dev-215:~/test# kill 5110\nroot@lan-dev-215:~/test# systemctl status test-server\n● test-server.service - my test service\n   Loaded: loaded (/lib/systemd/system/test-server.service; enabled; vendor preset: enabled)\n   Active: inactive (dead) since Fri 2020-01-31 21:34:53 CST; 2s ago\n  Process: 5506 ExecStart=/root/test/a.out (code=killed, signal=TERM)\n Main PID: 5506 (code=killed, signal=TERM)\n\nJan 31 21:34:43 lan-dev-215 a.out[5506]: hello 5\nJan 31 21:34:44 lan-dev-215 a.out[5506]: hello 6\nJan 31 21:34:45 lan-dev-215 a.out[5506]: hello 7\nJan 31 21:34:46 lan-dev-215 a.out[5506]: hello 8\nJan 31 21:34:47 lan-dev-215 a.out[5506]: hello 9\nJan 31 21:34:48 lan-dev-215 a.out[5506]: hello 10\nJan 31 21:34:49 lan-dev-215 a.out[5506]: hello 11\nJan 31 21:34:50 lan-dev-215 a.out[5506]: hello 12\nJan 31 21:34:51 lan-dev-215 a.out[5506]: hello 13\nJan 31 21:34:52 lan-dev-215 a.out[5506]: hello 14\n\nroot@lan-dev-215:~/test# ps aux | grep a.out\nroot      5562  0.0  0.0  14428  1056 pts/2    S+   21:37   0:00 grep --color=auto a.out\n")])])]),s("p",[t._v("可以看到test-server变成了inactive状态，a.out 也没有了。\n在test-server.service中增加Restart配置，配置为always")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("[Unit]\nDescription=my test service\n\n[Service]\nExecStart= /root/test/a.out\nRestart= always\n\n[Install]\nWantedBy=multi-user.target\n")])])]),s("p",[t._v("reload一下，让配置生效")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("systemctl daemon-reload\n")])])]),s("p",[t._v("此时test-server是运行状态了")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("root@lan-dev-215:~/test# systemctl status test-server\n● test-server.service - my test service\n   Loaded: loaded (/lib/systemd/system/test-server.service; enabled; vendor preset: enabled)\n   Active: active (running) since Fri 2020-01-31 21:42:05 CST; 34s ago\n Main PID: 5737 (a.out)\n   CGroup: /system.slice/test-server.service\n           └─5737 /root/test/a.out\n\nJan 31 21:42:30 lan-dev-215 a.out[5737]: hello 26\nJan 31 21:42:31 lan-dev-215 a.out[5737]: hello 27\nJan 31 21:42:32 lan-dev-215 a.out[5737]: hello 28\nJan 31 21:42:33 lan-dev-215 a.out[5737]: hello 29\nJan 31 21:42:34 lan-dev-215 a.out[5737]: hello 30\nJan 31 21:42:35 lan-dev-215 a.out[5737]: hello 31\nJan 31 21:42:36 lan-dev-215 a.out[5737]: hello 32\nJan 31 21:42:37 lan-dev-215 a.out[5737]: hello 33\nJan 31 21:42:38 lan-dev-215 a.out[5737]: hello 34\nJan 31 21:42:39 lan-dev-215 a.out[5737]: hello 35\n")])])]),s("p",[t._v("kill掉再看下")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("root@lan-dev-215:~/test# kill 5737\nroot@lan-dev-215:~/test# systemctl status test-server\n● test-server.service - my test service\n   Loaded: loaded (/lib/systemd/system/test-server.service; enabled; vendor preset: enabled)\n   Active: active (running) since Fri 2020-01-31 21:47:29 CST; 845ms ago\n Main PID: 5941 (a.out)\n    Tasks: 1\n   Memory: 128.0K\n      CPU: 2ms\n   CGroup: /system.slice/test-server.service\n           └─5941 /root/test/a.out\n\nJan 31 21:47:29 lan-dev-215 systemd[1]: Started my test service.\nJan 31 21:47:29 lan-dev-215 a.out[5941]: hello 1\n")])])]),s("p",[t._v("可以看到a.out重新运行了，实现了守护进程。")])])}),[],!1,null,null,null);e.default=n.exports}}]);