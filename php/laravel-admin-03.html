<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>laravel admin-03-验证码和防XSS攻击 | 小小郭的博客</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="小小郭">
    <link rel="preload" href="/assets/css/0.styles.f333096b.css" as="style"><link rel="preload" href="/assets/js/app.158714e6.js" as="script"><link rel="preload" href="/assets/js/2.a806d99a.js" as="script"><link rel="preload" href="/assets/js/44.37b08732.js" as="script"><link rel="prefetch" href="/assets/js/10.ceb6da30.js"><link rel="prefetch" href="/assets/js/11.f6fcdde7.js"><link rel="prefetch" href="/assets/js/12.c1ccc7c5.js"><link rel="prefetch" href="/assets/js/13.2e80b5f4.js"><link rel="prefetch" href="/assets/js/14.86580eea.js"><link rel="prefetch" href="/assets/js/15.ec8bc9ac.js"><link rel="prefetch" href="/assets/js/16.ffe6c259.js"><link rel="prefetch" href="/assets/js/17.f11cefb5.js"><link rel="prefetch" href="/assets/js/18.ba7fa50a.js"><link rel="prefetch" href="/assets/js/19.d98194cd.js"><link rel="prefetch" href="/assets/js/20.b3e3e3ba.js"><link rel="prefetch" href="/assets/js/21.0560925d.js"><link rel="prefetch" href="/assets/js/22.151f504b.js"><link rel="prefetch" href="/assets/js/23.c0dd585a.js"><link rel="prefetch" href="/assets/js/24.5ac8c4b5.js"><link rel="prefetch" href="/assets/js/25.57989e7c.js"><link rel="prefetch" href="/assets/js/26.19ae4c70.js"><link rel="prefetch" href="/assets/js/27.7b7a4013.js"><link rel="prefetch" href="/assets/js/28.c02de8fb.js"><link rel="prefetch" href="/assets/js/29.be98b5ac.js"><link rel="prefetch" href="/assets/js/3.f9a5341d.js"><link rel="prefetch" href="/assets/js/30.151ce4ad.js"><link rel="prefetch" href="/assets/js/31.e3b05220.js"><link rel="prefetch" href="/assets/js/32.48233f51.js"><link rel="prefetch" href="/assets/js/33.cdf1ba85.js"><link rel="prefetch" href="/assets/js/34.8e175bdf.js"><link rel="prefetch" href="/assets/js/35.53e76add.js"><link rel="prefetch" href="/assets/js/36.2588db5d.js"><link rel="prefetch" href="/assets/js/37.904d3476.js"><link rel="prefetch" href="/assets/js/38.1424f189.js"><link rel="prefetch" href="/assets/js/39.0e05003b.js"><link rel="prefetch" href="/assets/js/4.84d9a9b8.js"><link rel="prefetch" href="/assets/js/40.e4b36098.js"><link rel="prefetch" href="/assets/js/41.13258ed7.js"><link rel="prefetch" href="/assets/js/42.6f5a7cbb.js"><link rel="prefetch" href="/assets/js/43.7898149d.js"><link rel="prefetch" href="/assets/js/45.17998593.js"><link rel="prefetch" href="/assets/js/46.055bc79a.js"><link rel="prefetch" href="/assets/js/47.6df10fa7.js"><link rel="prefetch" href="/assets/js/48.2660180a.js"><link rel="prefetch" href="/assets/js/49.4625a12a.js"><link rel="prefetch" href="/assets/js/5.501f4465.js"><link rel="prefetch" href="/assets/js/50.b3b348da.js"><link rel="prefetch" href="/assets/js/51.dcb3be6c.js"><link rel="prefetch" href="/assets/js/52.7dd04b5b.js"><link rel="prefetch" href="/assets/js/53.20259b4b.js"><link rel="prefetch" href="/assets/js/54.c876d67f.js"><link rel="prefetch" href="/assets/js/55.52c8359c.js"><link rel="prefetch" href="/assets/js/56.ab71b89a.js"><link rel="prefetch" href="/assets/js/57.30af5fe9.js"><link rel="prefetch" href="/assets/js/58.d1f3acb8.js"><link rel="prefetch" href="/assets/js/59.0c65a864.js"><link rel="prefetch" href="/assets/js/6.56baaf4e.js"><link rel="prefetch" href="/assets/js/60.cc2dc3eb.js"><link rel="prefetch" href="/assets/js/61.bc3d577e.js"><link rel="prefetch" href="/assets/js/62.88dedbc6.js"><link rel="prefetch" href="/assets/js/63.5403d296.js"><link rel="prefetch" href="/assets/js/64.cdcabf93.js"><link rel="prefetch" href="/assets/js/65.7fba108e.js"><link rel="prefetch" href="/assets/js/66.51641258.js"><link rel="prefetch" href="/assets/js/67.f408a0b2.js"><link rel="prefetch" href="/assets/js/68.326016eb.js"><link rel="prefetch" href="/assets/js/69.9dde49ee.js"><link rel="prefetch" href="/assets/js/7.86ee5bb7.js"><link rel="prefetch" href="/assets/js/70.76be6feb.js"><link rel="prefetch" href="/assets/js/71.8bb3d5a3.js"><link rel="prefetch" href="/assets/js/72.3d340b56.js"><link rel="prefetch" href="/assets/js/73.94ae8b58.js"><link rel="prefetch" href="/assets/js/74.c38b2bf5.js"><link rel="prefetch" href="/assets/js/75.ab88131c.js"><link rel="prefetch" href="/assets/js/76.b15fc67e.js"><link rel="prefetch" href="/assets/js/8.77896323.js"><link rel="prefetch" href="/assets/js/9.1bb7c316.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f333096b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小小郭的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/about/index.html" class="nav-link">
  关于我
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="laravel-admin-03-验证码和防xss攻击"><a href="#laravel-admin-03-验证码和防xss攻击" class="header-anchor">#</a> laravel admin-03-验证码和防XSS攻击</h1> <h2 id="一-验证码"><a href="#一-验证码" class="header-anchor">#</a> 一.验证码</h2> <p>有个现成的库：https://github.com/Iamtong/laravel-admin-login-check-safe 直接拿来用吧。</p> <p>安装一下</p> <div class="language-bash extra-class"><pre class="language-bash"><code>composer require iamtong/laravel-admin-login-check-safe

php artisan vendor:publish --provider<span class="token operator">=</span>Encore<span class="token punctuation">\</span>LoginCheckSafe<span class="token punctuation">\</span>LoginCheckSafeServiceProvider
</code></pre></div><p>根据需求修改配置文件<code>config/admin.php</code>，主要是<code>extensions</code>字段</p> <div class="language-php extra-class"><pre class="language-php"><code> <span class="token single-quoted-string string">'login-check-safe'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
            <span class="token single-quoted-string string">'enable'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean constant">true</span><span class="token punctuation">,</span>
            <span class="token single-quoted-string string">'login-error-num'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token comment">//登录允许密码错误的次数</span>
            <span class="token single-quoted-string string">'login-error-limit-sec'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">600</span><span class="token punctuation">,</span><span class="token comment">//达到错误次数后锁定的时间（单位秒）</span>
            <span class="token single-quoted-string string">'password-expired'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">90</span><span class="token operator">*</span><span class="token number">86400</span><span class="token punctuation">,</span><span class="token comment">//密码过期时间 90 天（单位秒）</span>
            <span class="token single-quoted-string string">'password-expired-except-name'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'admin'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//排除账号不验证密码过期</span>
            <span class="token single-quoted-string string">'auto-out-sec'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1800</span><span class="token punctuation">,</span><span class="token comment">//多久没活跃后，自动退出账号（单位秒），设置为0时，表示不开启此功能</span>
            <span class="token single-quoted-string string">'limit-one-login'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token boolean constant">true</span><span class="token punctuation">,</span><span class="token comment">//是否开启 限制同时间一个账号仅限一人登录</span>
            <span class="token single-quoted-string string">'username-rules'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'regex:/^[a-zA-Z0-9]+$/i|between:3,40'</span><span class="token punctuation">,</span><span class="token comment">//用户名除了唯一性和必须填写之外的所有规则</span>
            <span class="token single-quoted-string string">'username-rules-msg'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
                <span class="token single-quoted-string string">'regex'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'用户名必须以大小写字母和数字组成'</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment">//对应的提示方法</span>
            <span class="token single-quoted-string string">'password-strong'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">// 【大写字母 小写字母 数字 特殊字符】 密码强度 必须使用其中的几种。</span>
            <span class="token single-quoted-string string">'password-length'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'6,40'</span><span class="token punctuation">,</span><span class="token comment">//密码长度范围 10,40 10到40位；</span>
            <span class="token single-quoted-string string">'db'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
                <span class="token comment">//密码修改纪录表</span>
                <span class="token single-quoted-string string">'password_log_table'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'admin_password_log'</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'password_log_model'</span> <span class="token operator">=</span><span class="token operator">&gt;</span>Encore\<span class="token package">LoginCheckSafe<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>PasswordLogModel</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token comment">//登录日志表</span>
                <span class="token single-quoted-string string">'login_log_table'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'admin_login_log'</span><span class="token punctuation">,</span>
                <span class="token single-quoted-string string">'login_log_model'</span> <span class="token operator">=</span><span class="token operator">&gt;</span>Encore\<span class="token package">LoginCheckSafe<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>LoginLogModel</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
</code></pre></div><p>由于会增加一些字段和表，要执行一下数据库变更</p> <div class="language-bash extra-class"><pre class="language-bash"><code>php artisan migrate
</code></pre></div><p>增加到中间件中</p> <p>在 <code>route.middleware</code>里面添加 <code>Encore\LoginCheckSafe\Http\Middleware\AdminCheck::class</code></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token single-quoted-string string">'middleware'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token single-quoted-string string">'web'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'admin'</span><span class="token punctuation">,</span>Encore\<span class="token package">LoginCheckSafe<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Middleware<span class="token punctuation">\</span>AdminCheck</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">]</span>
</code></pre></div><p><strong>注意事项</strong></p> <ol><li><p>如果数据库的变更文件没发布到database目录下，则去vendor下找到对应的文件，手动复制到database下，再执行变更。</p></li> <li><p>中文文件lang也是，手动复制下到resource对应的zh-cn下。对于要变更的，则在zh-cn对应的文件中添加或修改即可。</p></li></ol> <h2 id="二-防xss攻击"><a href="#二-防xss攻击" class="header-anchor">#</a> 二.防XSS攻击</h2> <p>laravel有个现成的库purifier，拿来直接用。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>composer require mews/purifier
</code></pre></div><p>安装完成后，在配置文件<code>config/app.php</code>的<code>providers</code>中注册HTMLPurifier服务提供者：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token single-quoted-string string">'providers'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
          
          Mews\<span class="token package">Purifier<span class="token punctuation">\</span>PurifierServiceProvider</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
</code></pre></div><p>然后在aliases中注册Purifier门面：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token single-quoted-string string">'aliases'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">[</span>
          <span class="token comment">// ...</span>
          <span class="token single-quoted-string string">'Purifier'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Mews\<span class="token package">Purifier<span class="token punctuation">\</span>Facades<span class="token punctuation">\</span>Purifier</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span>
</code></pre></div><p>发布配置文件到config目录：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>php artisan vendor:publish
</code></pre></div><p>在config目录下会生成一个purifier.php文件。</p> <p>这个配置文件里注意下，<code>'AutoFormat.AutoParagraph' =&gt; true,</code> 选项改为<code>false</code>，不然会在过滤字段中增加<code>&lt;p&gt;&lt;/p&gt;</code>字符</p> <p>之后在需要做防xss攻击的地方直接调用它即可,比如：</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$form</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">saving</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>Form <span class="token variable">$form</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token variable">$form</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">title</span> <span class="token operator">=</span> \<span class="token package">Purifier</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token variable">$form</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">title</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$form</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">uri</span> <span class="token operator">=</span> \<span class="token package">Purifier</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token variable">$form</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">uri</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div> <footer><div style="text-align: center;">
            © 2020 小小郭的博客
            <a href="http://www.beian.miit.gov.cn/">粤ICP备16016910号</a> <br><br></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.158714e6.js" defer></script><script src="/assets/js/2.a806d99a.js" defer></script><script src="/assets/js/44.37b08732.js" defer></script>
  </body>
</html>
